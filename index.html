<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>금단의 유혹: 마녀의 밤</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 기본 스타일 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #2c003e 0%, #4a006a 100%); /* 더 어둡고 신비로운 보라색 계열 */
            min-height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
        }

        .game-container {
            width: 100%;
            max-width: 400px;
            height: 100vh;
            max-height: 800px;
            background: #000;
            overflow: hidden;
            position: relative;
            border-radius: 0;
            box-shadow: 0 20px 40px rgba(0,0,0,0.7); /* 그림자 더 진하게 */
        }

        @media (min-width: 401px) {
            .game-container {
                border-radius: 20px;
                height: 800px;
            }
        }

        .game-screen {
            width: 100%;
            height: 100%;
            position: relative;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6); /* 오버레이 더 진하게 */
        }

        /* 캐릭터 이미지 크기 및 위치 조정 */
        .character-image {
            position: absolute;
            bottom: 5vh; /* 캐릭터를 더 위로 올리고 말풍선 아래에 위치하도록 조정 */
            left: 50%; /* 중앙 정렬을 위해 */
            transform: translateX(-50%); /* 정확한 중앙 정렬 */
            height: 70vh; /* 캐릭터 크기 조정 */
            max-height: 600px; /* 최대 높이 설정 */
            object-fit: contain;
            transition: all 0.3s ease;
            z-index: 2; /* UI 레이어보다 아래에 위치 */
        }

        .ui-layer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10; /* 캐릭터 이미지보다 위에 위치 */
        }

        /* 스탯 패널 디자인 개선 */
        .stats-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.95); /* 배경 더 진하게 */
            padding: 10px 15px; /* 패딩 조정 */
            border-radius: 12px; /* 모서리 더 둥글게 */
            color: white;
            z-index: 5;
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2열 유지 */
            gap: 10px; /* 간격 넓힘 */
            box-shadow: 0 5px 20px rgba(0,0,0,0.8);
        }

        .stat-bar {
            display: flex;
            align-items: center;
            gap: 10px; /* 간격 넓힘 */
            background: rgba(255,255,255,0.1); /* 각 바 배경 추가 */
            padding: 6px 10px;
            border-radius: 8px;
        }

        .stat-label {
            min-width: 40px; /* 레이블 너비 조정 */
            font-size: 13px; /* 폰트 크기 조정 */
            font-weight: 600; /* 폰트 두께 */
            color: #f0f0f0; /* 레이블 색상 */
        }

        .stat-progress {
            flex: 1;
            height: 8px; /* 진행 바 두께 */
            background: rgba(255,255,255,0.2);
            border-radius: 4px; /* 진행 바 모서리 */
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.3); /* 테두리 추가 */
        }

        .stat-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); /* 내부 그림자 */
        }

        /* 각 스탯 바 색상 */
        .belena-stat { background-color: #8a2be2; } /* 벨레나 - 보라 (지배) */
        .lilia-stat { background-color: #8b0000; } /* 릴리아 - 진홍 (유혹) */
        .celine-stat { background-color: #1e90ff; } /* 셀린 - 파랑 (순수) */
        .work-stat { background-color: #daa520; } /* 업무 - 황금 (성공) */

        /* 반짝이는 이펙트 키프레임 */
        @keyframes sparkle-glow {
            0% { box-shadow: 0 0 5px rgba(255,255,255,0.7), inset 0 1px 3px rgba(0,0,0,0.2); }
            50% { box-shadow: 0 0 15px rgba(255,255,255,1), inset 0 1px 3px rgba(0,0,0,0.2); }
            100% { box-shadow: 0 0 5px rgba(255,255,255,0.7), inset 0 1px 3px rgba(0,0,0,0.2); }
        }

        /* 반짝이는 이펙트 클래스 */
        .stat-fill.sparkle {
            animation: sparkle-glow 0.8s ease-out; /* 짧고 눈에 띄는 애니메이션 */
        }

        /* 말풍선 디자인 개선 */
        .dialogue-container {
            background: rgba(255,255,255,0.9); /* 단일 배경색으로 변경 */
            margin: 10px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.2);
            position: relative; /* 화살표를 위한 상대 위치 */
            transition: background 0.3s ease; /* 투명도 변화 애니메이션 추가 */
        }

        /* 선택지가 나올 때 말풍선 투명도 조절 */
        .dialogue-container.dialogue-choices-active {
            background: rgba(255,255,255,0.7); /* 더 투명하게 */
        }

        .main-dialogue-box {
            padding: 20px;
            min-height: 100px;
            position: relative;
            background: transparent; /* 배경을 투명하게 */
        }

        /* 내레이션 디자인 변경 */
        .main-dialogue-box.narration-style {
            background: rgba(0,0,0,0.8); /* 어두운 배경 */
            color: white; /* 흰색 텍스트 */
            border-left: none; /* 기존 border 제거 */
            border-radius: 15px; /* 둥근 모서리 유지 */
            text-align: center; /* 중앙 정렬 */
            font-style: italic;
            padding: 25px 20px; /* 패딩 조정 */
            box-shadow: 0 5px 15px rgba(0,0,0,0.6);
        }

        .main-dialogue-box.narration-style .speaker-name {
            color: #ccc; /* 내레이션 화자 이름 색상 변경 */
            font-style: italic;
            margin-bottom: 5px;
        }

        .main-dialogue-box.narration-style .dialogue-text {
            color: #eee; /* 내레이션 텍스트 색상 변경 */
        }

        /* 캐릭터 대화 스타일 (기존 유지, 배경만 명확히) */
        .main-dialogue-box.character-style {
            background: transparent; /* dialogue-container가 배경을 담당 */
        }

        .speaker-name {
            font-weight: 700;
            font-size: 18px;
            color: #333;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .speaker-name.narration {
            color: #666;
            font-style: italic;
            margin-bottom: 5px;
        }

        .dialogue-text {
            font-size: 16px;
            line-height: 1.7;
            color: #444;
            word-break: keep-all;
        }

        .choices-container {
            padding: 20px 30px;
            border-top: 1px solid rgba(0,0,0,0.1);
            background: rgba(255,255,255,0.05); /* 더 투명하게 */
        }

        .choice-button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            margin: 8px 0;
            background: linear-gradient(145deg, #fff, #f0f0f0);
            border: 2px solid transparent;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-family: 'Noto Sans KR', sans-serif;
            touch-action: manipulation;
        }

        .choice-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            background: linear-gradient(145deg, #f8f8f8, #e8e8e8);
            border-color: #8a2be2; /* 보라색 테두리 */
        }

        .choice-button:active {
            transform: translateY(0);
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-8px);
            }
            60% {
                transform: translateY(-4px);
            }
        }

        /* 타이틀 스크린 개선 */
        .title-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* 로고를 하단에 배치 */
            align-items: center;
            color: white;
            z-index: 100;
            cursor: pointer; /* 클릭 가능한 영역임을 표시 */
            padding-bottom: 50px; /* 로고 하단 여백 */
        }

        .title-screen .game-title,
        .title-screen .game-subtitle {
            display: none; /* 타이틀 화면에서 텍스트 제목 숨김 */
        }

        .game-logo {
            width: 80%; /* 로고 크기 조정 */
            max-width: 250px;
            height: auto;
            object-fit: contain;
            animation: float 3s ease-in-out infinite; /* 둥둥 떠다니는 효과 */
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5)); /* 그림자 추가 */
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }

        .ending-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a002a 0%, #3a005a 100%); /* 엔딩 화면 배경도 어둡게 */
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 40px;
            z-index: 100;
            /* 엔딩 화면 이펙트 추가 */
            animation: ending-glow 2s infinite alternate; /* 새로운 애니메이션 적용 */
        }

        /* 새로운 엔딩 화면 이펙트 키프레임 */
        @keyframes ending-glow {
            0% { box-shadow: 0 0 10px rgba(138,43,226,0.5), 0 0 20px rgba(138,43,226,0.3); } /* 보라색 빛 */
            100% { box-shadow: 0 0 20px rgba(138,43,226,0.8), 0 0 40px rgba(138,43,226,0.5); }
        }


        .ending-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .ending-text {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 30px;
            max-width: 90%;
        }

        .restart-button {
            padding: 14px 30px;
            background: linear-gradient(145deg, #8a2be2, #6a0dad); /* 보라색 그라데이션 */
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Sans KR', sans-serif;
            touch-action: manipulation;
        }

        .restart-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .restart-button:active {
            transform: translateY(0);
        }

        /* 전체화면 일러스트 */
        .fullscreen-illust {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .fullscreen-illust img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .illust-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            padding: 40px 20px 20px;
        }

        .illust-dialogue {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .illust-dialogue .speaker-name {
            color: #ffffff;
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 10px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .illust-dialogue .dialogue-text {
            color: #ffffff;
            font-size: 16px;
            line-height: 1.6;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .illust-choices {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .illust-choice-button {
            background: rgba(255, 255, 255, 0.15); /* 더 투명하게 */
            backdrop-filter: blur(8px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 14px 20px;
            color: #ffffff;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Sans KR', sans-serif;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }

        .illust-choice-button:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: #8a2be2;
            transform: translateY(-2px);
        }

        /* 페이드 인 효과 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 마법 에너지/파편 이펙트 */
        .magic-effects {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* 이펙트가 클릭을 방해하지 않도록 */
            overflow: hidden;
            z-index: 20;
        }

        .magic-spark { /* 마법 파편 */
            position: absolute;
            background-color: #8a2be2; /* 보라색 마법 파편 */
            width: 10px;
            height: 10px;
            border-radius: 50%;
            transform: scale(0);
            animation: sparkFloat 1.5s forwards ease-out;
            opacity: 0;
            box-shadow: 0 0 8px #8a2be2, 0 0 15px #8a2be2;
        }

        @keyframes sparkFloat {
            0% {
                opacity: 0;
                transform: translateY(0) scale(0);
            }
            20% {
                opacity: 1;
                transform: translateY(-20px) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(0.5);
            }
        }

        /* 갤러리 화면 스타일 */
        .gallery-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* 배경색 변경 */
            background: linear-gradient(135deg, #1a002a 0%, #3a005a 100%); /* 어두운 마법 배경 */
            display: none; /* 초기에는 숨김 */
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            color: #eee; /* 텍스트 색상 조정 */
            z-index: 101; /* 다른 UI보다 위에 */
            padding: 20px;
            overflow-y: auto; /* 스크롤 가능 */
        }

        .gallery-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #e0b0ff; /* 연한 보라색 제목 */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 90%;
            justify-content: center;
            margin-bottom: 20px;
        }

        .gallery-item {
            background: rgba(255,255,255,0.05); /* 더 어둡고 투명하게 */
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(138,43,226,0.2); /* 보라색 그림자 */
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            min-height: 150px; /* 최소 높이 설정 */
            border: 1px solid rgba(138,43,226,0.3); /* 보라색 테두리 */
        }

        .gallery-item img {
            width: 100%;
            height: 90px; /* 이미지 높이 고정 */
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 5px;
            border: 2px solid #8a2be2; /* 보라색 테두리 */
        }

        .gallery-item.uncollected {
            background: rgba(50,50,50,0.5); /* 더 어둡고 투명하게 */
            color: #777;
            font-size: 30px;
            font-weight: 700;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .gallery-item.uncollected::after {
            content: '?';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            color: #555; /* 더 어두운 물음표 */
        }
        .gallery-item.uncollected .item-name {
            font-size: 14px;
            color: #888; /* 미수집 이름 색상 조정 */
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
        }

        .gallery-item .item-name {
            font-size: 14px;
            font-weight: 500;
            color: #eee; /* 수집된 이름 색상 조정 */
            word-break: keep-all;
        }

        .gallery-close-button {
            padding: 12px 25px;
            background: linear-gradient(145deg, #8a2be2, #6a0dad); /* 보라색 그라데이션 */
            border: none;
            border-radius: 20px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Noto Sans KR', sans-serif;
            touch-action: manipulation;
            margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4); /* 그림자 추가 */
        }

        .gallery-close-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
        }

        /* Gallery Image Overlay */
        .gallery-image-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9); /* 더 진한 오버레이 */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 102; /* Higher than gallery screen */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .gallery-image-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .gallery-image-overlay img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(138,43,226,0.7); /* 보라색 빛 */
            object-fit: contain;
        }

        .overlay-close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2); /* 더 투명하게 */
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .overlay-close-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Collection Progress Bar */
        .collection-progress {
            width: 100%;
            max-width: 350px;
            margin-bottom: 20px;
            text-align: center;
        }

        .progress-bar-container {
            width: 100%;
            height: 15px;
            background: rgba(255, 255, 255, 0.15); /* 더 어둡게 */
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #8a2be2, #6a0dad); /* 보라색 그라데이션 */
            border-radius: 10px;
            width: 0%; /* Controlled by JS */
            transition: width 0.5s ease-out;
        }

        .progress-percentage {
            font-size: 16px;
            font-weight: 600;
            color: #eee; /* 텍스트 색상 조정 */
            margin-top: 5px;
            display: block;
        }

        /* Adjust main title screen button for consistency */
        #showGalleryButton {
            background: linear-gradient(145deg, #8a2be2, #6a0dad) !important; /* 보라색 */
            color: white !important;
            border-radius: 15px !important;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4) !important;
        }
        #showGalleryButton:hover {
            background: linear-gradient(145deg, #6a0dad, #5a0a9a) !important;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5) !important;
        }

        /* Password Popup Style */
        .password-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }

        .password-popup-content {
            background: #333;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            color: white;
            box-shadow: 0 0 20px rgba(138,43,226,0.7);
            max-width: 80%;
        }

        .password-popup-content h3 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #e0b0ff;
        }

        .password-popup-content p {
            font-size: 28px;
            font-weight: bold;
            color: #ffeb3b;
            margin-bottom: 20px;
        }

        .password-popup-content button {
            padding: 10px 20px;
            background: linear-gradient(145deg, #8a2be2, #6a0dad);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .password-popup-content button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- 배경 음악 플레이어 -->
        <audio id="background-music" src="https://github.com/heyrichoi/witch/raw/refs/heads/main/Royalty%20Free%20Music)%20%EC%B9%98%EB%AA%85%EC%A0%81%EC%9D%B8%20%EB%B8%8C%EA%B8%88%20%20Masquerade%20%5B%EA%B3%A0%ED%98%B9%EC%A0%81_%EC%84%B9%EC%8B%9C_%EB%8A%90%EC%99%80%EB%A5%B4%5D%20fascinating_sexy_noir.mp3" loop volume="0.3" autoplay></audio>

        <!-- 효과음 플레이어: 선택지 클릭 시 -->
        <audio id="choice-sound" src="https://github.com/heyrichoi/love/raw/refs/heads/main/Storytelling%20Cartoon%20PopVocal%2003.mp3" preload="auto" volume="0.5"></audio>
        <!-- 효과음 플레이어: 호감도 상승 시 (마법 효과음으로 변경) -->
        <audio id="affection-sound" src="https://github.com/heyrichoi/love/raw/refs/heads/main/Ascending%207.mp3" preload="auto" volume="0.5"></audio>

        <!-- 타이틀 스크린 -->
        <div class="title-screen" id="titleScreen">
            <h1 class="game-title">금단의 유혹: 마녀의 밤</h1>
            <p class="game-subtitle">운명을 지배하는 자, 혹은 지배당하는 자</p>
            <!-- 게임 로고는 JS에서 설정 -->
            <img id="gameLogo" class="game-logo" src="" alt="게임 로고">
            <!-- 수집한 에피소드 버튼 추가 -->
            <button class="restart-button" id="showGalleryButton" style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 150px; padding: 10px 15px; font-size: 14px; background: linear-gradient(145deg, #8a2be2, #6a0dad); color: white; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; transition: all 0.3s ease; z-index: 101;">수집한 기억</button>
        </div>

        <!-- 게임 스크린 -->
        <div class="game-screen" id="gameScreen">
            <div class="overlay"></div>
            
            <!-- 스탯 패널 -->
            <div class="stats-panel">
                <div class="stat-bar">
                    <span class="stat-label">벨레나 지배</span>
                    <div class="stat-progress">
                        <div class="stat-fill belena-stat" id="belenaDominanceBar" style="width: 0%"></div>
                    </div>
                    <span id="belenaDominanceValue">0</span>
                </div>
                <div class="stat-bar">
                    <span class="stat-label">릴리아 유혹</span>
                    <div class="stat-progress">
                        <div class="stat-fill lilia-stat" id="liliaSeductionBar" style="width: 0%"></div>
                    </div>
                    <span id="liliaSeductionValue">0</span>
                </div>
                <div class="stat-bar">
                    <span class="stat-label">셀린 순수</span>
                    <div class="stat-progress">
                        <div class="stat-fill celine-stat" id="celinePurityBar" style="width: 0%"></div>
                    </div>
                    <span id="celinePurityValue">0</span>
                </div>
                <div class="stat-bar">
                    <span class="stat-label">마력</span>
                    <div class="stat-progress">
                        <div class="stat-fill work-stat" id="magicPowerBar" style="width: 50%"></div>
                    </div>
                    <span id="magicPowerValue">50</span>
                </div>
            </div>
            
            <!-- 캐릭터 이미지 -->
            <img class="character-image" id="characterImage" src="" alt="캐릭터" style="display: none;">
            
            <!-- UI 레이어 -->
            <div class="ui-layer">
                <div class="dialogue-container" id="dialogueContainer">
                    <div class="main-dialogue-box" id="dialogueBox">
                        <div class="speaker-name" id="speakerName"></div>
                        <div class="dialogue-text" id="dialogueText"></div>
                    </div>
                    <div class="choices-container" id="choicesContainer" style="display: none;">
                        <!-- 선택지들이 여기에 동적으로 추가됩니다 -->
                    </div>
                </div>
            </div>

            <!-- 마법 파편 이펙트 컨테이너 -->
            <div class="magic-effects" id="magicEffects"></div>

            <!-- 전체화면 일러스트 -->
            <div class="fullscreen-illust" id="fullscreenIllust" style="display: none;">
                <img id="fullscreenImage" src="" alt="특별 일러스트">
                <div class="illust-overlay">
                    <div class="illust-dialogue" id="illustDialogue"></div>
                    <div class="illust-choices" id="illustChoices"></div>
                </div>
            </div>
        </div>

        <!-- 엔딩 스크린 -->
        <div class="ending-screen" id="endingScreen">
            <h2 class="ending-title" id="endingTitle"></h2>
            <p class="ending-text" id="endingText"></p>
            <button class="restart-button" onclick="restartGame()">다시 시작</button>
        </div>

        <!-- 갤러리 화면 -->
        <div class="gallery-screen" id="galleryScreen">
            <h2 class="gallery-title">수집한 기억의 조각</h2>
            <div class="collection-progress">
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="progressBarFill"></div>
                </div>
                <span id="progressPercentage" class="progress-percentage">0%</span>
            </div>
            <div class="gallery-grid" id="galleryGrid">
                <!-- 갤러리 아이템들이 여기에 동적으로 추가됩니다 -->
            </div>
            <button class="gallery-close-button" onclick="hideGalleryScreen()">닫기</button>
        </div>

        <!-- Gallery Image Overlay -->
        <div class="gallery-image-overlay" id="galleryImageOverlay">
            <img id="overlayImage" src="" alt="Collected Image">
            <button class="overlay-close-button" onclick="hideImageOverlay()">X</button>
        </div>

        <!-- Password Popup HTML -->
        <div id="passwordPopup" class="password-popup" style="display: none;">
            <div class="password-popup-content">
                <h3>공략집에서 비밀번호를 입력하고 더 에로한 일러스트를 확인하세요!</h3>
                <p>비밀번호: 3060</p>
                <button onclick="hidePasswordPopup()">닫기</button>
            </div>
        </div>
    </div>

    <script>
        // 이미지 URLs (기존 이미지 URL을 재활용하며, 의미만 변경)
        const IMAGE_URLS = {
            // 게임 시스템
            GAME_LOGO: "https://imgur.com/wvwkRJr.jpg",
            OPENING_ILLUST: "https://imgur.com/D40eRow.jpg",
            
            // 캐릭터 기본 이미지 (기존 이미지 재활용)
            BELENA_BASE: "https://imgur.com/unTnIQB.jpg",
            LILIA_BASE: "https://imgur.com/Um2oHzg.jpg",
            CELINE_BASE: "https://imgur.com/kr2YFqo.jpg", // 셀린 일러스트 업데이트
            
            // 배경 이미지 (기존 이미지 재활용)
            DARK_FOREST: "https://imgur.com/NIzVNZH.jpg", // 어두운 숲
            RUINED_CASTLE: "https://imgur.com/Pi6xXrK.jpg", // 폐허가 된 성 (마녀들의 거점)
            MYSTERY_STREET: "https://imgur.com/U88KHR6.jpg", // 신비로운 거리 낮
            MOONLIT_PATH: "https://imgur.com/aHnvTE7.jpg", // 달빛 비치는 길 (밤)
            FORBIDDEN_ALTAR: "https://imgur.com/KnUQcZd.jpg", // 금단의 제단 (벨레나 의식)
            SECRET_CAVE: "https://imgur.com/r2EeiEc.jpg", // 비밀 동굴 (마녀들의 연회)
            SACRED_GROVE: "https://imgur.com/1WKUdiZ.jpg", // 신성한 숲 (셀린 약초 채집)
            ANCIENT_LIBRARY: "https://imgur.com/I7AQ0LS.jpg", // 고대 도서관 (릴리아 연구)
            
            // 벨레나 특별 이벤트 일러스트 (기존 이미지 재활용)
            BELENA_CAPTURED: "https://imgur.com/uvBZwBa.jpg", // 벨레나의 함정에 걸림
            BELENA_CONTRACT_SCENE: "https://imgur.com/TJQX9PS.jpg", // 명계의 계약서
            BELENA_RITUAL_CUT: "https://imgur.com/9gf3RQj.jpg", // 붉은 의식의 방
            BELENA_DOMINANCE_CUT: "https://imgur.com/9Vw8X2A.jpg", // 벨레나 지배의 카리스마 (업데이트)
            BELENA_CONFESSION_CUT: "https://imgur.com/3Z0ffM2.jpg", // 벨레나 고백
            BELENA_COLLECTION_END: "https://imgur.com/JxRJOoU.jpg", // 벨레나의 소장품 (엔딩)
            
            // 릴리아 특별 이벤트 일러스트 (기존 이미지 재활용)
            LILIA_SEDUCTION_CUT: "https://imgur.com/soKOWmI.jpg", // 연무 속 관능극
            LILIA_MIST_CUT: "https://imgur.com/cC5Zhq5.jpg", // 빗속의 관능
            LILIA_GARDEN_CUT: "https://imgur.com/VQOhkVl.jpg", // 은월의 정원
            LILIA_CONFLICT_CUT: "https://imgur.com/FCMW94N.jpg", // 릴리아 갈등
            LILIA_CONFESSION_CUT: "https://imgur.com/c2jsDbr.jpg", // 릴리아 고백
            LILIA_ETERNAL_END: "https://imgur.com/qlRCEk5.jpg", // 영원한 환상 (엔딩)
            
            // 셀린 특별 이벤트 일러스트 (기존 이미지 재활용)
            CELINE_RESCUE: "https://imgur.com/1iBPqHp.jpg", // 깨진 보호막 (셀린 등장)
            CELINE_HEALING_CUT: "https://imgur.com/ncFuyHP.jpg", // 금단의 회복
            CELINE_PURE_TOUCH_CUT: "https://imgur.com/V2mqWbE.jpg", // 순수한 손길
            CELINE_SHIELD_CUT: "https://imgur.com/rL8unZ8.jpg", // 셀린 보호막
            CELINE_CONFLICT_CUT: "https://imgur.com/cfunOtC.jpg", // 셀린 갈등
            CELINE_MARRIAGE: "https://imgur.com/zwF6DVH.jpg", // 영원한 맹세 (엔딩)
            CELINE_EMOTION_END: "https://imgur.com/Drzqwbv.jpg", // 눈을 감고 피어난 감정 (엔딩)
            
            // 트루 루트 이미지 (세 마녀의 심판 - 3개 이미지로 분리)
            THREE_WITCHES_JUDGMENT_1: "https://imgur.com/bIcCVJU.jpg",
            THREE_WITCHES_JUDGMENT_2: "https://imgur.com/6eKEgJY.jpg",
            THREE_WITCHES_JUDGMENT_3: "https://imgur.com/jYhpdeb.jpg",
            TRUE_CONTRACT_END: "https://imgur.com/XBR4S8N.jpg",
            
            // 엔딩 일러스트 (기존 이미지 재활용)
            BELENA_HAPPY_END: "https://imgur.com/muCBD2k.jpg", // 벨레나 해피 엔딩 (업데이트됨)
            LILIA_HAPPY_END: "https://imgur.com/6ruDZ1p.jpg",
            CELINE_HAPPY_END: "https://imgur.com/eBDk9MP.jpg", // 셀린 해피 엔딩 (업데이트됨)
            BELENA_EROTIC_END: "https://github.com/heyrichoi/witch/blob/main/pixai-1906547944971113554-3.png?raw=true", // 벨레나 에로 엔딩 (업데이트됨)
            LILIA_EROTIC_END: "https://github.com/heyrichoi/witch/blob/main/pixai-1906533195007341902-3.png?raw=true",   // 릴리아 에로 엔딩 (업데이트됨)
            CELINE_EROTIC_END: "https://imgur.com/LKsDrEB.jpg", // 셀린 에로 엔딩
            BELENA_BAD_END: "https://imgur.com/LRAnmpb.jpg",
            LILIA_BAD_END: "https://imgur.com/baQhjAA.jpg",
            CELINE_BAD_END: "https://imgur.com/3vFGxOK.jpg",
            BELENA_NTR_ILLUST: "https://imgur.com/xObcvPt.jpg", // 벨레나 NTR 에피소드
            BELENA_NTR_FINAL_END: "https://imgur.com/2B9q32N.jpg", // 벨레나 NTR 최종 엔딩
            FAILURE_END: "https://imgur.com/tzUfVzs.jpg", // 실패 엔딩

            // NEW: 하렘 에로 에필로그 일러스트
            HAREM_EROTIC_BELENA_LILIA: "https://github.com/heyrichoi/witch/blob/main/pixai-1907918002179724131-1.png?raw=true", // 벨레나와 릴리아 유혹
            HAREM_EROTIC_BELENA: "https://github.com/heyrichoi/witch/blob/main/pixai-1907916164857040363-0.png?raw=true", // 벨레나 단독 유혹
            HAREM_EROTIC_CELINE: "https://github.com/heyrichoi/witch/blob/main/pixai-1907932490430895781-1.png?raw=true", // 셀린 유혹
            HAREM_FINAL_EROTIC: "https://github.com/heyrichoi/witch/blob/main/pixai-1907922978273768293-1.png?raw=true" // 최종 엔딩 일러스트
        };

        // 게임 상태
        let gameState = {
            currentScene: 'prologue',
            belenaDominance: 0,  // 벨레나 지배력
            liliaSeduction: 0,   // 릴리아 유혹력
            celinePurity: 0,     // 셀린 순수도
            magicPower: 50,      // 마력
            currentTextIndex: 0,
            isTyping: false,
            collectedIllusts: {}
        };

        // 갤러리에 표시될 일러스트 목록과 이름 (IMAGE_URLS의 키와 매핑)
        const GALLERY_ILLUST_MAP = {
            "BELENA_CAPTURED": "벨레나: 붉은 의식의 방",
            "LILIA_SEDUCTION_CUT": "릴리아: 연무 속 관능극",
            "CELINE_RESCUE": "셀린: 깨진 보호막",
            "BELENA_CONTRACT_SCENE": "벨레나: 명계의 계약서",
            "LILIA_MIST_CUT": "릴리아: 빗속의 유혹",
            "CELINE_HEALING_CUT": "셀린: 금단의 치유",
            "BELENA_RITUAL_CUT": "벨레나: 밤의 의식",
            "LILIA_GARDEN_CUT": "릴리아: 은월의 정원",
            "CELINE_PURE_TOUCH_CUT": "셀린: 순수한 손길",
            "BELENA_DOMINANCE_CUT": "벨레나: 지배의 카리스마",
            "LILIA_CONFLICT_CUT": "릴리아: 어둠의 줄다리기",
            "CELINE_CONFLICT_CUT": "셀린: 믿음의 시험",
            "BELENA_CONFESSION_CUT": "벨레나: 불타는 고백",
            "LILIA_CONFESSION_CUT": "릴리아: 깊은 유혹",
            "CELINE_MARRIAGE": "셀린: 영원한 맹세",
            "THREE_WITCHES_JUDGMENT_1": "트루: 벨레나의 심판",
            "THREE_WITCHES_JUDGMENT_2": "트루: 릴리아의 심판",
            "THREE_WITCHES_JUDGMENT_3": "트루: 셀린의 심판",
            "TRUE_CONTRACT_END": "트루: 운명을 함께하는 계약",
            "BELENA_HAPPY_END": "벨레나: 영원한 지배",
            "LILIA_HAPPY_END": "릴리아: 영원한 환상",
            "CELINE_HAPPY_END": "셀린: 따뜻한 미래",
            "BELENA_EROTIC_END": "벨레나: 금단의 쾌락",
            "LILIA_EROTIC_END": "릴리아: 탐닉의 밤",
            "CELINE_EROTIC_END": "셀린: 순수의 타락",
            "BELENA_BAD_END": "벨레나: 잃어버린 지배",
            "LILIA_BAD_END": "릴리아: 깨진 유혹",
            "CELINE_BAD_END": "셀린: 멀어진 순수",
            "BELENA_NTR_ILLUST": "벨레나: 씁쓸한 미소",
            "BELENA_NTR_FINAL_END": "벨레나: 놓쳐버린 유혹",
            "FAILURE_END": "실패: 어둠 속 방황",
            "HAREM_EROTIC_BELENA": "하렘: 벨레나의 유혹",
            "HAREM_EROTIC_BELENA_LILIA": "하렘: 벨레나와 릴리아의 유혹",
            "HAREM_EROTIC_CELINE": "하렘: 셀린의 수줍은 질투",
            "HAREM_FINAL_EROTIC": "하렘: 영원히 타락한 밤"
        };


        // DOM 요소 가져오기
        const titleScreen = document.getElementById('titleScreen');
        const gameScreen = document.getElementById('gameScreen');
        const endingScreen = document.getElementById('endingScreen');
        const endingTitle = document.getElementById('endingTitle');
        const endingText = document.getElementById('endingText');
        const galleryScreen = document.getElementById('galleryScreen');
        const galleryGrid = document.getElementById('galleryGrid');
        const showGalleryButton = document.getElementById('showGalleryButton');

        const dialogueContainer = document.getElementById('dialogueContainer');
        const dialogueBox = document.getElementById('dialogueBox');
        const speakerName = document.getElementById('speakerName');
        const dialogueText = document.getElementById('dialogueText');
        const choicesContainer = document.getElementById('choicesContainer');
        const characterImage = document.getElementById('characterImage');
        const gameBackground = document.getElementById('gameScreen');
        const gameLogo = document.getElementById('gameLogo');

        const belenaDominanceBar = document.getElementById('belenaDominanceBar');
        const belenaDominanceValue = document.getElementById('belenaDominanceValue');
        const liliaSeductionBar = document.getElementById('liliaSeductionBar');
        const liliaSeductionValue = document.getElementById('liliaSeductionValue');
        const celinePurityBar = document.getElementById('celinePurityBar');
        const celinePurityValue = document.getElementById('celinePurityValue');
        const magicPowerBar = document.getElementById('magicPowerBar');
        const magicPowerValue = document.getElementById('magicPowerValue');

        const fullscreenIllust = document.getElementById('fullscreenIllust');
        const fullscreenImage = document.getElementById('fullscreenImage');
        const illustDialogueDiv = document.getElementById('illustDialogue');
        const illustChoicesDiv = document.getElementById('illustChoices');

        const magicEffectsContainer = document.getElementById('magicEffects');
        const backgroundMusic = document.getElementById('background-music');
        const choiceSound = document.getElementById('choice-sound');
        const affectionSound = document.getElementById('affection-sound');

        const galleryImageOverlay = document.getElementById('galleryImageOverlay');
        const overlayImage = document.getElementById('overlayImage');
        const progressBarFill = document.getElementById('progressBarFill');
        const progressPercentage = document.getElementById('progressPercentage');

        // Password Popup DOM elements
        const passwordPopup = document.getElementById('passwordPopup');

        // 로컬 스토리지 키
        const COLLECTED_ILLUSTS_KEY = 'witch_romance_collected_illusts';

        // Global variable to track current index within a multi-illust fullscreen scene
        let currentFullscreenIllustIndex = 0;

        // Global handler for fullscreen illust clicks
        let currentFullscreenClickHandler = null;

        // 호감도 획득량 추가 상수
        const AFFECTION_BONUS = 3;

        // 게임 장면들 (완전히 새로운 스토리 흐름)
        const scenes = {
            // 프롤로그: 숲의 속박
            prologue: {
                speaker: "내레이션",
                text: [
                    "어둠이 깔린 숲, 길을 잃고 헤매던 나는 낯선 기운에 이끌려 깊숙한 곳으로 들어섰다.",
                    "발밑에서 섬뜩한 마법진이 빛나고, 나의 의지와 상관없이 몸이 묶이는 것을 느꼈다.",
                    "벨레나의 차가운 카리스마가 나를 짓눌렀다. 온몸의 감각이 마비되는 듯했다."
                ],
                background: IMAGE_URLS.DARK_FOREST,
                character: null,
                choices: [{ text: "다음", next: "belena_trap_cutscene" }]
            },
            belena_trap_cutscene: {
                speaker: "벨레나",
                text: [
                    "흥미롭군. 내 영역에 발을 들이다니. 네 의지인가, 아니면 그저 어리석음인가?",
                    "이 마법진은 너의 모든 것을 속박할 것이다. 네 영혼까지도... 나의 지배를 느껴봐. 나의 노예가 되어라."
                ],
                background: IMAGE_URLS.DARK_FOREST,
                character: null,
                fullscreen: IMAGE_URLS.BELENA_CAPTURED,
                illustKey: "BELENA_CAPTURED",
                choices: [{ text: "다음", next: "lilia_appearance_in_trap" }]
            },
            lilia_appearance_in_trap: {
                speaker: "내레이션",
                text: [
                    "벨레나의 마법진이 나를 묶는 순간, 어둠 속에서 농밀한 향기와 함께 또 다른 존재가 모습을 드러냈다.",
                    "검은 레이스 드레스을 입은 매혹적인 흑마법사, 릴리아였다.",
                    "그녀의 등장과 함께 숲의 공기는 더욱 관능적인 유혹으로 변했다. 나의 시선은 그녀의 붉은 문신에 닿았다."
                ],
                background: IMAGE_URLS.DARK_FOREST,
                character: IMAGE_URLS.LILIA_BASE,
                choices: [{ text: "다음", next: "belena_lilia_double_temptation" }]
            },
            belena_lilia_double_temptation: {
                speaker: "내레이션",
                text: [
                    "벨레나의 차가운 지배욕과 릴리아의 뜨거운 유혹이 동시에 나를 덮쳐왔다.",
                    "나의 영혼은 갈피를 잡지 못하고 흔들렸다. 이 매혹에서 벗어날 수 있을까?",
                    "벨레나의 시선은 나를 꿰뚫는 듯했고, 릴리아의 손짓은 나의 심장을 쥐어짜는 듯했다.",
                    "나의 심장이 격렬하게 뛰었다. 이 금지된 감각에 몸이 떨렸다."
                ],
                background: IMAGE_URLS.DARK_FOREST,
                character: null,
                choices: [
                    { text: "벨레나의 지배에 복종하겠다고 생각한다 (그녀의 힘을 원한다)", effects: { belenaDominance: 15 + AFFECTION_BONUS, liliaSeduction: 5 + Math.floor(AFFECTION_BONUS/2), celinePurity: 5 + Math.floor(AFFECTION_BONUS/2), magicPower: 5 }, next: "celine_rescue_intervention" },
                    { text: "릴리아의 유혹에 몸을 맡기겠다고 생각한다 (그녀의 쾌락을 원한다)", effects: { liliaSeduction: 15 + AFFECTION_BONUS, belenaDominance: 5 + Math.floor(AFFECTION_BONUS/2), celinePurity: 5 + Math.floor(AFFECTION_BONUS/2), magicPower: 5 }, next: "celine_rescue_intervention" },
                    { text: "어떻게든 이 상황에서 벗어나려 발버둥친다 (자유를 갈망한다)", effects: { celinePurity: 5 + Math.floor(AFFECTION_BONUS/2), belenaDominance: 5, liliaSeduction: 5, magicPower: 5 }, next: "celine_rescue_intervention" }
                ]
            },
            celine_rescue_intervention: {
                speaker: "내레이션",
                text: [
                    "두 마녀의 마력이 나를 짓누르는 순간, 하늘에서 찬란한 빛이 쏟아졌다.",
                    "순수하고 맑은 금발 치유사, 셀린이었다.",
                    "그녀는 나를 구하기 위해 보호막을 펼쳤지만, 마법의 충돌로 인해 함께 휘말리고 말았다.",
                    "그녀의 따뜻한 손길이 나의 차가워진 피부에 닿았다. 묘한 안도감이 밀려왔다. 마치 어둠 속 한 줄기 빛처럼..."
                ],
                background: IMAGE_URLS.DARK_FOREST,
                character: IMAGE_URLS.CELINE_BASE,
                choices: [{ text: "다음", next: "celine_shield_cutscene" }]
            },
            celine_shield_cutscene: {
                speaker: "셀린",
                text: [
                    "이런, 위험한 곳에 오셨군요. 괜찮으세요? 제가 도와드릴게요!",
                    "저들의 마법은 위험해요. 당신의 영혼을 잠식할 수도 있어요. 부디... 저를 믿어주세요!"
                ],
                background: IMAGE_URLS.DARK_FOREST,
                character: null,
                fullscreen: IMAGE_URLS.CELINE_RESCUE,
                illustKey: "CELINE_RESCUE",
                choices: [{ text: "다음", next: "after_rescue_wake_up" }]
            },
            after_rescue_wake_up: {
                speaker: "내레이션",
                text: [
                    "정신을 차려보니 나는 폐허가 된 성의 침대에 누워 있었다.",
                    "몸의 속박은 풀렸지만, 마력의 잔재가 온몸을 휘감는 듯했다. 묘한 쾌감이 느껴졌다.",
                    "셀린이 옆에서 나를 지켜보고 있었다. 그녀의 순수한 눈빛이 나를 안정시켰다.",
                    "그녀의 손이 나의 이마를 스쳤다. 따뜻한 온기가 온몸에 퍼졌다."
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: IMAGE_URLS.CELINE_BASE,
                choices: [{ text: "다음", next: "celine_explanation" }]
            },
            celine_explanation: {
                speaker: "셀린",
                text: [
                    "다행이에요, 정신을 차리셨군요. 당신은 벨레나와 릴리아의 마법에 깊이 노출되었어요.",
                    "그들의 마력은 당신의 영혼에 스며들어 쉽게 떨어지지 않을 거예요.",
                    "이곳에서 제 치유를 받으며 마력을 정화해야 해요. 저의 손길로...",
                    "벨레나와 릴리아도 당신의 특별한 마력을 감지하고 이곳에 머물게 하는 것에 동의했어요.",
                    "당분간은 이곳에서 지내야 할 거예요. 마녀들과 엘프, 그리고 당신... 우리와 함께..."
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: IMAGE_URLS.CELINE_BASE,
                choices: [{ text: "다음", next: "chapter1_start" }]
            },

            // 챕터 1: 마녀의 부름 (성에서의 첫 날)
            chapter1_start: {
                speaker: "내레이션",
                text: [
                    "마녀들의 성에서의 생활이 시작되었다. 나의 마력은 불안정했다.",
                    "세 여인의 존재는 나를 자극했다. 밤은 길고, 유혹은 깊어졌다.",
                    "벨레나는 차가운 눈으로 나를 응시하며 지배적인 기운을 뿜어냈고,",
                    "릴리아는 나른한 미소로 은밀한 유혹을 던졌다. 셀린은 걱정스러운 표정으로 나를 바라보며 순수한 위로를 건넸다."
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: null,
                choices: [{ text: "다음", next: "first_confrontation" }]
            },
            first_confrontation: {
                speaker: "내레이션",
                text: [
                    "성에서의 첫 날 밤, 세 여인이 각자의 방식으로 나에게 다가왔다.",
                    "그들의 마력이 나를 시험하는 듯했다.",
                    "나의 불안정한 마력을 느끼며, 누구의 부름에 먼저 응할까?",
                    "누구의 손길이 나를 더 깊이 이끌까? 나의 욕망은 어디로 향할까?"
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: null,
                choices: [
                    { text: "벨레나의 지배적인 시선을 받아들인다 (그녀의 힘을 원한다)", effects: { belenaDominance: 15 + AFFECTION_BONUS, liliaSeduction: 5, celinePurity: 5, magicPower: 5 }, next: "belena_first_offer" },
                    { text: "릴리아의 매혹적인 목소리에 집중한다 (그녀의 쾌락을 원한다)", effects: { liliaSeduction: 15 + AFFECTION_BONUS, belenaDominance: 5, celinePurity: 5, magicPower: 5 }, next: "lilia_first_offer" },
                    { text: "셀린의 순수한 걱정에 응답한다 (따뜻한 위로를 원한다)", effects: { celinePurity: 5 + AFFECTION_BONUS, belenaDominance: 5, liliaSeduction: 5, magicPower: 5 }, next: "celine_first_offer" }
                ]
            },
            belena_first_offer: {
                speaker: "벨레나",
                text: [
                    "나의 지배를 받아들인다면, 너는 이 세계에서 가장 강력한 존재가 될 수 있을 것이다.",
                    "모든 것은 너의 손에 들어올 거야. 너의 영혼까지도 나의 것이 될 테지. 나의 노예가 되어라.",
                    "어떤가? 나의 힘을 원하는가? 아니면 나약하게 저항하다가 부서질 것인가?",
                    "선택해. 너의 모든 것을 나에게 바쳐봐."
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: IMAGE_URLS.BELENA_BASE,
                choices: [
                    { text: "당신의 지배를 따르겠습니다 (복종의 쾌락을 느낀다)", effects: { belenaDominance: 15 + AFFECTION_BONUS, magicPower: 10 }, next: "chapter1_end" },
                    { text: "아직은... 저항하고 싶습니다 (자유를 갈망한다)", effects: { belenaDominance: -5, magicPower: -5 }, next: "chapter1_end" }
                ]
            },
            lilia_first_offer: {
                speaker: "릴리아",
                text: [
                    "나의 금지된 마법은 너에게 새로운 감각을 일깨워줄 거야.",
                    "세상의 모든 쾌락과 비밀을 알게 될 테지. 나의 유혹에 몸을 맡겨봐.",
                    "영원히 헤어나올 수 없을 만큼 달콤할 테니...",
                    "두려워 말아요. 나의 유혹에 몸을 맡겨봐. 영원히 헤어나올 수 없을 만큼 달콤할 테니...",
                    "나의 어둠 속으로... 나의 품으로..."
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: IMAGE_URLS.LILIA_BASE,
                choices: [
                    { text: "당신의 유혹에 빠져들겠습니다 (금단의 쾌락을 탐한다)", effects: { liliaSeduction: 15 + AFFECTION_BONUS, magicPower: 10 }, next: "chapter1_end" },
                    { text: "당신의 마법은 너무 위험합니다 (이성을 지키려 한다)", effects: { liliaSeduction: -5, magicPower: -5 }, next: "chapter1_end" }
                ]
            },
            celine_first_offer: {
                speaker: "셀린",
                text: [
                    "저는 당신을 해치지 않아요. 제 치유의 힘으로 당신을 보호하고 싶어요.",
                    "당신의 영혼을 정화할 수 있어요. 저의 순수함을 믿어주세요.",
                    "이곳은 위험한 곳이지만, 당신이 저를 믿어준다면...",
                    "제가 당신의 빛이 되어줄게요. 저의 따뜻한 손길을..."
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: IMAGE_URLS.CELINE_BASE,
                choices: [
                    { text: "당신을 믿고 따르겠습니다 (따뜻한 위로를 원한다)", effects: { celinePurity: 15 + AFFECTION_BONUS, magicPower: 10 }, next: "chapter1_end" },
                    { text: "당신을 믿기 힘듭니다 (경계심을 늦추지 않는다)", effects: { celinePurity: -5, magicPower: -5 }, next: "chapter1_end" }
                ]
            },
            chapter1_end: {
                speaker: "내레이션",
                text: [
                    "첫 번째 밤의 선택이 끝났다. 나는 마녀들의 세계에 한 발 더 깊이 들어섰다.",
                    "밤은 계속되고, 나의 마력 또한 점차 증폭되고 있었다.",
                    "마력의 불안정함을 해소할 방법을 찾아야 했다. 몸이 뜨겁게 달아오르는 것을 느꼈다."
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: null,
                choices: [{ text: "다음", next: "daily_event_1" }] // Added daily event
            },
            // NEW: Daily Event 1
            daily_event_1: {
                speaker: "벨레나",
                text: [
                    "흥미롭군. 이른 아침부터 안뜰을 거닐다니. 뭔가 찾는 것이라도 있나?",
                    "아니면... 나의 시선을 갈망하는 건가?",
                    "네 마력의 흐름이 불안정해 보이는군. 나의 훈련을 받아들인다면, 곧 안정될 것이다.",
                    "어떤가? 나의 지배를 경험하고 싶지 않나?"
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: IMAGE_URLS.BELENA_BASE,
                choices: [
                    { text: "벨레나와 함께 마법 훈련을 한다", effects: { belenaDominance: 10 + AFFECTION_BONUS, magicPower: 5 }, next: "magic_stabilization_event" },
                    { text: "다른 마녀를 찾아본다", effects: { belenaDominance: -2, liliaSeduction: 2, celinePurity: 2 }, next: "daily_event_1_choose_other" } // Corrected next scene
                ]
            },
            // NEW: Daily Event 1 - Choose Other Witch
            daily_event_1_choose_other: {
                speaker: "내레이션",
                text: [
                    "벨레나의 제안을 뒤로하고, 다른 마녀를 찾아보기로 했다.",
                    "누구를 찾아볼까?"
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: null,
                choices: [
                    { text: "릴리아를 찾아본다", effects: { liliaSeduction: 10 + AFFECTION_BONUS }, next: "daily_event_1_lilia_found" },
                    { text: "셀린을 찾아본다", effects: { celinePurity: 10 + AFFECTION_BONUS }, next: "daily_event_1_celine_found" }
                ]
            },
            // NEW: Daily Event 1 - Lilia Found
            daily_event_1_lilia_found: {
                speaker: "릴리아",
                text: [
                    "어머, 나를 찾아왔군요. 당신의 호기심은 언제나 나를 즐겁게 해요.",
                    "혹시 고대 서적에 숨겨진 비밀에 대해 궁금한 것이라도 있나요?",
                    "나와 함께라면, 세상의 모든 금지된 지식을 탐할 수 있을 거예요."
                ],
                background: IMAGE_URLS.ANCIENT_LIBRARY,
                character: IMAGE_URLS.LILIA_BASE,
                choices: [{ text: "다음", next: "magic_stabilization_event" }]
            },
            // NEW: Daily Event 1 - Celine Found
            daily_event_1_celine_found: {
                speaker: "셀린",
                text: [
                    "저를 찾아오셨군요. 혹시 불편한 곳이라도 있으신가요?",
                    "이곳의 마력은 때로 영혼에 부담을 주기도 해요.",
                    "제 치유 마법으로 당신을 편안하게 해드릴 수 있어요. 부디, 저를 믿어주세요."
                ],
                background: IMAGE_URLS.SACRED_GROVE,
                character: IMAGE_URLS.CELINE_BASE,
                choices: [{ text: "다음", next: "magic_stabilization_event" }]
            },
            magic_stabilization_event: {
                speaker: "내레이션",
                text: [
                    "밤이 깊어질수록 나의 마력은 더욱 불안정해졌다. 온몸이 뜨거워지고, 알 수 없는 갈증이 밀려왔다.",
                    "마력을 안정시킬 방법이 필요했다.",
                    "그때, 세 여인 중 한 명이 나에게 다가왔다.",
                    "누구의 도움을 받을 것인가? 누구의 손길이 이 뜨거움을 식혀줄까?"
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: null,
                choices: [
                    { text: "벨레나에게 마력 안정화를 부탁한다 (그녀의 지배를 받아들인다)", effects: { belenaDominance: 15 + AFFECTION_BONUS, liliaSeduction: 5, celinePurity: 5, magicPower: 15 }, next: "daily_event_2" }, // Next to daily event 2
                    { text: "릴리아에게 마력 안정화를 부탁한다 (그녀의 유혹에 빠져든다)", effects: { liliaSeduction: 15 + AFFECTION_BONUS, belenaDominance: 5, celinePurity: 5, magicPower: 15 }, next: "daily_event_2" }, // Next to daily event 2
                    { text: "셀린에게 마력 안정화를 부탁한다 (그녀의 치유를 믿는다)", effects: { celinePurity: 15 + AFFECTION_BONUS, belenaDominance: 5, liliaSeduction: 5, magicPower: 15 }, next: "daily_event_2" } // Next to daily event 2
                ]
            },
            // NEW: Daily Event 2
            daily_event_2: {
                speaker: "릴리아",
                text: [
                    "어머, 여기서 만나다니. 당신의 마력은 여전히 흥미롭군요.",
                    "혹시 금지된 지식에 관심이 있나요? 고대 서적에는 숨겨진 쾌락이 가득하답니다.",
                    "나와 함께라면, 세상의 모든 비밀을 알게 될 거예요.",
                    "나의 유혹에 빠져들 준비가 되었나요?"
                ],
                background: IMAGE_URLS.ANCIENT_LIBRARY,
                character: IMAGE_URLS.LILIA_BASE,
                choices: [
                    { text: "릴리아와 함께 고대 서적을 탐독한다", effects: { liliaSeduction: 10 + AFFECTION_BONUS, magicPower: 5 }, next: "chapter2_start" },
                    { text: "다른 마녀를 찾아본다", effects: { liliaSeduction: -2, belenaDominance: 2, celinePurity: 2 }, next: "daily_event_2_choose_other" } // Corrected next scene
                ]
            },
            // NEW: Daily Event 2 - Choose Other Witch
            daily_event_2_choose_other: {
                speaker: "내레이션",
                text: [
                    "릴리아의 제안을 뒤로하고, 다른 마녀를 찾아보기로 했다.",
                    "누구를 찾아볼까?"
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: null,
                choices: [
                    { text: "벨레나를 찾아본다", effects: { belenaDominance: 10 + AFFECTION_BONUS }, next: "chapter2_start" },
                    { text: "셀린을 찾아본다", effects: { celinePurity: 10 + AFFECTION_BONUS }, next: "chapter2_start" }
                ]
            },

            // 챕터 2: 금단의 교류
            chapter2_start: {
                speaker: "내레이션",
                text: [
                    "마력의 불안정함이 해소되자, 나는 마녀들의 성에서의 생활에 더욱 깊이 적응하게 되었다.",
                    "그들과의 교류는 더욱 은밀하고 개인적으로 변해갔다. 밤은 깊어지고, 유혹은 더욱 강렬해졌다.",
                    "어느 날, 벨레나가 나를 개인 연구실로 불렀다. 그녀의 눈빛은 무언가를 지시하고 있었다.",
                    "그녀의 지배가 시작될 시간이었다."
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: null,
                choices: [{ text: "다음", next: "belena_private_lesson" }]
            },
            belena_private_lesson: {
                speaker: "벨레나",
                text: [
                    "네 마력의 잠재력은 꽤 흥미롭군. 하지만 아직 다듬어지지 않았어.",
                    "나의 손길이 필요할 테지. 나의 지배를 받아들여라.",
                    "나의 지배 마법을 가르쳐주지. 나의 힘을 받아들인다면, 너는 더욱 강해질 것이다.",
                    "너의 모든 것을 나에게 바쳐봐. 너의 영혼까지도...",
                    "어떤가? 나의 가르침을 받을 준비가 되었나?",
                    "나의 지배 아래서... 나의 노예가 되어라."
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: IMAGE_URLS.BELENA_BASE,
                choices: [
                    { text: "기꺼이 배우겠습니다 (그녀의 지배를 탐한다)", effects: { belenaDominance: 15 + AFFECTION_BONUS, magicPower: 8 }, next: "daily_event_3" }, // Next to daily event 3
                    { text: "당신의 방식은 너무 가혹합니다 (자유를 갈망한다)", effects: { belenaDominance: -3, magicPower: -3 }, next: "daily_event_3" } // Next to daily event 3
                ]
            },
            // NEW: Daily Event 3
            daily_event_3: {
                speaker: "셀린",
                text: [
                    "훈련 후 많이 지쳐 보이세요. 제 치유 마법이 필요할지도 몰라요.",
                    "이곳의 마력은 강해서, 때로는 영혼에 부담을 주기도 하죠.",
                    "제가 채집한 약초로 만든 차를 마셔보세요. 몸과 마음이 편안해질 거예요.",
                    "당신이 편안해지는 것이 저의 기쁨이에요."
                ],
                background: IMAGE_URLS.SACRED_GROVE,
                character: IMAGE_URLS.CELINE_BASE,
                choices: [
                    { text: "셀린의 치유를 받는다", effects: { celinePurity: 10 + AFFECTION_BONUS, magicPower: 5 }, next: "lilia_ancient_library_invite" },
                    { text: "혼자서 쉬겠다", effects: { celinePurity: -2, belenaDominance: 2, liliaSeduction: 2 }, next: "daily_event_3_choose_other" } // Corrected next scene
                ]
            },
            // NEW: Daily Event 3 - Choose Other Witch
            daily_event_3_choose_other: {
                speaker: "내레이션",
                text: [
                    "셀린의 제안을 뒤로하고, 다른 마녀를 찾아보기로 했다.",
                    "누구를 찾아볼까?"
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: null,
                choices: [
                    { text: "벨레나를 찾아본다", effects: { belenaDominance: 10 + AFFECTION_BONUS }, next: "lilia_ancient_library_invite" },
                    { text: "릴리아를 찾아본다", effects: { liliaSeduction: 10 + AFFECTION_BONUS }, next: "lilia_ancient_library_invite" }
                ]
            },
            lilia_ancient_library_invite: {
                speaker: "내레이션",
                text: [
                    "벨레나와의 대화 후, 릴리아가 나에게 다가왔다.",
                    "그녀의 손에는 오래된 마법서가 들려 있었다. 그녀의 향기가 나를 유혹했다.",
                    "그녀는 나에게 고대 도서관에서 함께 금지된 지식을 탐구하자고 제안했다.",
                    "둘만의 은밀한 탐험이 될 것이다. 금단의 쾌락이 기다리고 있었다."
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: IMAGE_URLS.LILIA_BASE,
                choices: [{ text: "다음", next: "lilia_library_study" }]
            },
            lilia_library_study: {
                speaker: "릴리아",
                text: [
                    "이 마법서는 금지된 지식으로 가득 차 있어요.",
                    "함께 탐구한다면, 세상의 비밀과 쾌락을 알게 될 거예요. 나의 어둠 속으로...",
                    "두렵지 않나요? 나의 유혹에 빠져들면, 돌이킬 수 없을 텐데...",
                    "영원히 나의 것이 될 텐데... 나의 품에서..."
                ],
                background: IMAGE_URLS.ANCIENT_LIBRARY,
                character: IMAGE_URLS.LILIA_BASE,
                choices: [
                    { text: "당신과 함께라면 두렵지 않습니다 (금단의 지식을 탐한다)", effects: { liliaSeduction: 15 + AFFECTION_BONUS, magicPower: 8 }, next: "daily_event_4" }, // Next to daily event 4
                    { text: "너무 위험한 지식입니다 (이성을 지키려 한다)", effects: { liliaSeduction: -3, magicPower: -3 }, next: "daily_event_4" } // Next to daily event 4
                ]
            },
            // NEW: Daily Event 4
            daily_event_4: {
                speaker: "벨레나",
                text: [
                    "숲은 마력의 근원이다. 이곳에서 너의 잠재력을 시험해 볼 수 있지.",
                    "어떤 마법이 너의 본능을 자극하는가?",
                    "나의 지배 마법은 너의 내면을 깨울 것이다. 두려워 말고, 나를 따르라.",
                    "너의 모든 것을 나에게 바쳐라."
                ],
                background: IMAGE_URLS.DARK_FOREST,
                character: IMAGE_URLS.BELENA_BASE,
                choices: [
                    { text: "벨레나의 가르침을 따른다", effects: { belenaDominance: 10 + AFFECTION_BONUS, magicPower: 5 }, next: "celine_sacred_grove_encounter" },
                    { text: "혼자서 숲을 탐색한다", effects: { belenaDominance: -2, liliaSeduction: 2, celinePurity: 2 }, next: "daily_event_4_choose_other" } // Corrected next scene
                ]
            },
            // NEW: Daily Event 4 - Choose Other Witch
            daily_event_4_choose_other: {
                speaker: "내레이션",
                text: [
                    "벨레나의 제안을 뒤로하고, 다른 마녀를 찾아보기로 했다.",
                    "누구를 찾아볼까?"
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: null,
                choices: [
                    { text: "릴리아를 찾아본다", effects: { liliaSeduction: 10 + AFFECTION_BONUS }, next: "celine_sacred_grove_encounter" },
                    { text: "셀린을 찾아본다", effects: { celinePurity: 10 + AFFECTION_BONUS }, next: "celine_sacred_grove_encounter" }
                ]
            },
            celine_sacred_grove_encounter: {
                speaker: "내레이션",
                text: [
                    "고대 도서관에서 돌아오던 길, 신성한 숲에서 약초를 채집하던 엘프 치유사 셀린과 마주쳤다.",
                    "그녀의 순수한 미소가 나를 위로했다.",
                    "그녀는 나의 얼굴을 보고 걱정스러운 표정을 지었다.",
                    "그녀의 따뜻한 손길이 나의 뺨을 스쳤다. 묘한 안도감이 밀려왔다."
                ],
                background: IMAGE_URLS.SACRED_GROVE,
                character: IMAGE_URLS.CELINE_BASE,
                choices: [{ text: "다음", next: "celine_healing_offer" }]
            },
            celine_healing_offer: {
                speaker: "셀린",
                text: [
                    "당신의 마력이 불안정해 보여요. 혹시 무리하고 계신가요? 제 치유가 필요할지도...",
                    "제 치유 마법으로 당신을 도와드릴 수 있어요. 부디... 저를 믿어주세요!",
                    "저의 따뜻한 손길을..."
                ],
                background: IMAGE_URLS.SACRED_GROVE,
                character: IMAGE_URLS.CELINE_BASE,
                choices: [
                    { text: "당신의 치유를 받겠습니다 (그녀의 순수함에 안긴다)", effects: { celinePurity: 15 + AFFECTION_BONUS, magicPower: 8 }, next: "celine_healing_process" },
                    { text: "혼자서도 괜찮습니다 (스스로를 지키려 한다)", effects: { celinePurity: -3, magicPower: -3 }, next: "chapter2_end_conflict_intro" }
                ]
            },
            // NEW: 셀린의 치유 과정 상세 묘사
            celine_healing_process: {
                speaker: "내레이션",
                text: [
                    "셀린의 손길이 나의 몸에 닿자, 따뜻한 마력이 온몸을 감쌌다.",
                    "불안정했던 마력이 서서히 안정되고, 그와 함께 알 수 없는 쾌감이 밀려왔다.",
                    "그녀의 손가락이 나의 피부를 스칠 때마다 미묘한 전율이 흘렀다.",
                    "순수한 치유 마법 속에서, 나는 그녀의 따뜻함과 묘한 관능을 동시에 느꼈다.",
                    "셀린의 숨결이 나의 귓가를 스쳤다. 그녀의 맑은 눈동자가 나를 깊이 들여다보았다.",
                    "이 순간, 나는 그녀의 순수함에 대한 갈망을 느꼈다."
                ],
                background: IMAGE_URLS.CELINE_HEALING_CUT,
                character: null,
                fullscreen: IMAGE_URLS.CELINE_HEALING_CUT,
                illustKey: "CELINE_HEALING_CUT",
                choices: [{ text: "다음", next: "celine_healing_aftermath" }]
            },
            celine_healing_aftermath: {
                speaker: "셀린",
                text: [
                    "이제 괜찮으실 거예요. 당신의 마력이 안정되었어요. 제 치유가 도움이 되었기를 바라요.",
                    "당신과 함께 있으면... 제 마음도 편안해져요. 마치 오랜 인연처럼...",
                    "당신은 저에게 특별한 존재예요. 저의 모든 것을 바치고 싶어요."
                ],
                background: IMAGE_URLS.SACRED_GROVE,
                character: IMAGE_URLS.CELINE_BASE,
                choices: [{ text: "다음", next: "daily_event_5" }] // Next to daily event 5
            },
            // NEW: Daily Event 5
            daily_event_5: {
                speaker: "릴리아",
                text: [
                    "밤의 연회는 마녀들의 진정한 모습을 보여주는 시간이죠. 당신도 함께 즐기겠어요?",
                    "이곳에서는 금지된 마법과 쾌락이 넘쳐난답니다. 나의 유혹에 몸을 맡겨봐요.",
                    "두려워 말고, 나의 손을 잡아요. 영원히 헤어나올 수 없는 밤을 선사해 줄게요.",
                    "나의 어둠 속으로... 나의 품으로..."
                ],
                background: IMAGE_URLS.SECRET_CAVE,
                character: IMAGE_URLS.LILIA_BASE,
                choices: [
                    { text: "릴리아와 함께 연회에 참석한다", effects: { liliaSeduction: 10 + AFFECTION_BONUS, magicPower: 5 }, next: "chapter2_end_conflict_intro" },
                    { text: "연회에 참석하지 않고 휴식을 취한다", effects: { liliaSeduction: -2, belenaDominance: 2, celinePurity: 2 }, next: "chapter2_end_conflict_intro" }
                ]
            },
            chapter2_end_conflict_intro: {
                speaker: "내레이션",
                text: [
                    "마녀들과 엘프 치유사와의 교류가 깊어질수록, 그들 사이의 미묘한 긴장감도 커져갔다.",
                    "밤은 더욱 깊어지고, 욕망은 충돌했다.",
                    "어느 밤, 벨레나와 릴리아는 마법 이론을 두고 격렬하게 대립하기 시작했고,",
                    "셀린은 그 사이에서 안타까워했다. 나는 그들의 갈등 속에 서 있었다.",
                    "그들의 욕망이 충돌하는 소리가 들렸다. 나의 심장은 격렬하게 뛰었다."
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: null,
                choices: [{ text: "다음", next: "chapter2_conflict_choices" }]
            },
            chapter2_conflict_choices: {
                speaker: "내레이션",
                text: [
                    "세 여인의 주장이 팽팽하게 맞선다. 누구의 편을 들어줄 것인가? 누구의 욕망을 채워줄 것인가?",
                    "나의 선택이 그들의 운명을 바꿀 것이다. 이 밤의 지배자가 될 것인가, 아니면 유혹에 빠질 것인가?"
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: null,
                choices: [
                    { text: "벨레나의 지배적인 이론을 지지한다 (그녀의 힘을 강화한다)", effects: { belenaDominance: 18 + AFFECTION_BONUS, liliaSeduction: -5, celinePurity: -5 }, next: "conflict_belena_outcome" },
                    { text: "릴리아의 금지된 이론을 지지한다 (그녀의 유혹에 빠져든다)", effects: { liliaSeduction: 18 + AFFECTION_BONUS, belenaDominance: -5, celinePurity: -5 }, next: "conflict_lilia_outcome" },
                    { text: "셀린의 순수한 이론을 지지한다 (그녀의 순수함을 지킨다)", effects: { celinePurity: 18 + AFFECTION_BONUS, belenaDominance: -5, liliaSeduction: -5 }, next: "conflict_celine_outcome" },
                    { text: "중립을 지키며 중재를 시도한다 (모두의 욕망을 자극한다)", effects: { belenaDominance: 10 + AFFECTION_BONUS, liliaSeduction: 10 + AFFECTION_BONUS, celinePurity: 10 + AFFECTION_BONUS, magicPower: 15 }, next: "conflict_neutral_outcome" }
                ]
            },
            conflict_belena_outcome: {
                speaker: "벨레나",
                text: [
                    "역시 너는 나의 선택이 옳았음을 증명하는군!",
                    "나의 지배를 받아들인다면, 더 큰 힘을 얻을 것이다.",
                    "나의 충실한 노예가 되어라. 너의 모든 것을 나의 것으로 만들 테지.",
                    "나의 지배를 느껴봐."
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: IMAGE_URLS.BELENA_BASE,
                choices: [{ text: "다음", next: "belena_dominance_illust_cut" }]
            },
            belena_dominance_illust_cut: {
                speaker: "벨레나",
                text: [
                    "우리 둘이서라면 뭐든지 할 수 있을 거야! 이 세상 끝까지 지배할 수 있어!",
                    "나의 충실한 종이 되어라! 너의 모든 것을 바쳐라! 나의 지배를 느껴라!"
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: null,
                fullscreen: IMAGE_URLS.BELENA_DOMINANCE_CUT,
                illustKey: "BELENA_DOMINANCE_CUT",
                choices: [{ text: "다음", next: "chapter3_start" }]
            },
            conflict_lilia_outcome: {
                speaker: "릴리아",
                text: [
                    "당신은 나의 유혹에 넘어왔군요. 합리적인 판단이에요.",
                    "당신의 이성이 저를 더욱 흥분시켜요.",
                    "나의 어둠 속으로... 나의 품으로... 당신의 모든 것을 저에게 주세요."
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: IMAGE_URLS.LILIA_BASE,
                choices: [{ text: "다음", next: "lilia_conflict_illust_cut" }]
            },
            lilia_conflict_illust_cut: {
                speaker: "릴리아",
                text: [
                    "당신의 지지는 저에게 큰 힘이 됩니다. 당신은 저의 유일한 약점이에요.",
                    "나의 모든 것을 줄게요.",
                    "앞으로도 함께 금지된 마법을 탐구하고 싶어요...",
                    "나의 어둠 속으로... 영원히... 나의 쾌락을 느껴봐요."
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: null,
                fullscreen: IMAGE_URLS.LILIA_CONFLICT_CUT,
                illustKey: "LILIA_CONFLICT_CUT",
                choices: [{ text: "다음", next: "chapter3_start" }]
            },
            conflict_celine_outcome: {
                speaker: "셀린",
                text: [
                    "제 의견에 동의해주셔서... 정말 기뻐요. 당신의 순수함이 저를 뜨겁게 만들어요.",
                    "나의 모든 것을 바칠게요. 저의 순수한 사랑을... 당신의 품으로..."
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: IMAGE_URLS.CELINE_BASE,
                choices: [{ text: "다음", next: "celine_conflict_illust_cut" }]
            },
            celine_conflict_illust_cut: {
                speaker: "셀린",
                text: [
                    "당신 덕분에 용기를 얻었어요. 당신은 저의 빛이에요. 저의 모든 것이에요.",
                    "앞으로도... 잘 부탁드려요. 저의 모든 것을 받아주세요.",
                    "저의 순수한 사랑을... 저의 품으로..."
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: null,
                fullscreen: IMAGE_URLS.CELINE_CONFLICT_CUT,
                illustKey: "CELINE_CONFLICT_CUT",
                choices: [{ text: "다음", next: "chapter3_start" }]
            },
            conflict_neutral_outcome: {
                speaker: "내레이션",
                text: [
                    "나의 현명한 중재 덕분에 세 여인은 합의점을 찾고, 갈등은 해결되었다.",
                    "모두에게 좋은 인상을 남겼다.",
                    "나의 마력 또한 더욱 증폭되었다. 나는 이제 그들의 중심에 서 있었다."
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: null,
                choices: [{ text: "다음", next: "chapter3_start" }]
            },

            // 챕터 3: 운명의 시험
            chapter3_start: {
                speaker: "내레이션",
                text: [
                    "시간이 흘러, 나는 마녀들과 엘프 치유사의 세계에 완전히 동화되었다.",
                    "세 여인과의 관계는 더욱 깊고 뜨거워졌다. 나의 마력은 최고조에 달했다. 밤은 더욱 농밀해졌다.",
                    "이제 나의 운명을 결정할 마지막 시험이 다가오고 있었다.",
                    "누구의 손을 잡을 것인가? 누구의 품에 안길 것인가? 나의 욕망은 어디로 향할까?"
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: null,
                choices: [{ text: "다음", next: "final_stage_check" }]
            },

            // 최종 엔딩 분기 로직
            final_stage_check: {
                speaker: "내레이션",
                text: [
                    "나의 노력과 선택이 결실을 맺을 시간이다. 누구와 가장 뜨거운 밤을 보낼 준비가 되었는가?",
                    "나의 모든 것을 걸고... 운명을 확인해 보자."
                ],
                background: IMAGE_URLS.RUINED_CASTLE,
                character: null,
                choices: [],
                onEnter: function() {
                    const { belenaDominance, liliaSeduction, celinePurity, magicPower } = gameState;
                    let nextScene = 'failure_ending_epilogue';

                    // 1. 트루 엔딩 (가장 높은 우선순위)
                    if (belenaDominance >= 70 && liliaSeduction >= 70 && celinePurity >= 70 && magicPower >= 80) {
                        nextScene = 'true_ending_judgment_sequence_start';
                    }
                    // 2. 개별 해피 엔딩 (이제 에로 엔딩 선택지 포함)
                    else if (belenaDominance >= 60 && belenaDominance > liliaSeduction && belenaDominance > celinePurity) {
                        nextScene = 'belena_happy_or_erotic_choice';
                    } else if (liliaSeduction >= 60 && liliaSeduction > belenaDominance && liliaSeduction > celinePurity) {
                        nextScene = 'lilia_happy_or_erotic_choice';
                    } else if (celinePurity >= 60 && celinePurity > belenaDominance && celinePurity > liliaSeduction) {
                        nextScene = 'celine_happy_or_erotic_choice';
                    }
                    // 3. 벨레나 NTR 엔딩 (벨레나 지배력이 높지만 해피 엔딩 조건 미달 + 다른 여인 호감도도 높은 경우)
                    else if (belenaDominance >= 50 && belenaDominance < 60 && liliaSeduction >= 40 && celinePurity >= 40) {
                        nextScene = 'belena_ntr_ending_episode';
                    }
                    // 4. 개별 배드 엔딩
                    else if (belenaDominance >= 50 && belenaDominance > liliaSeduction && belenaDominance > celinePurity) {
                        nextScene = 'belena_bad_ending_epilogue';
                    } else if (liliaSeduction >= 50 && liliaSeduction > belenaDominance && liliaSeduction > celinePurity) {
                        nextScene = 'lilia_bad_ending_epilogue';
                    } else if (celinePurity >= 50 && celinePurity > belenaDominance && celinePurity > liliaSeduction) {
                        nextScene = 'celine_bad_ending_epilogue';
                    }
                    // 5. 일반 실패 엔딩
                    else if (magicPower < 30 || (belenaDominance < 50 && liliaSeduction < 50 && celinePurity < 50)) {
                        nextScene = 'failure_ending_epilogue';
                    }
                    else { // 그 외 모든 경우
                        nextScene = 'failure_ending_epilogue';
                    }
                    
                    scenes.final_stage_check.choices = [{ text: "운명 확인", next: nextScene }];
                }
            },

            // --- 벨레나 루트 ---
            // 벨레나 해피/에로 엔딩 선택지 씬
            belena_happy_or_erotic_choice: {
                speaker: "내레이션",
                text: [
                    "벨레나의 차가운 눈빛이 나를 지배한다. 그녀의 손길이 나의 뺨을 스치고,",
                    "이 밤, 그녀와 어떤 결말을 맞이할 것인가?",
                    "영원한 지배인가, 아니면 금단의 쾌락인가?"
                ],
                background: IMAGE_URLS.FORBIDDEN_ALTAR,
                character: IMAGE_URLS.BELENA_BASE,
                choices: [
                    { text: "영원한 지배를 선택한다 (일반 해피 엔딩)", next: "belena_confession_scene" },
                    { text: "금단의 쾌락을 탐한다 (에로 엔딩)", next: "belena_erotic_ending_epilogue" }
                ]
            },
            belena_confession_scene: {
                speaker: "내레이션",
                text: [
                    "벨레나와의 관계는 단순한 속박을 넘어선 지 오래다.",
                    "그녀의 차가운 시선 뒤에 숨겨진 뜨거운 욕망이 나를 지배한다.",
                    "어느 날 밤, 벨레나가 나를 붉은 의식의 방으로 불러낸다.",
                    "둘만의 은밀한 공간에서... 그녀의 지배가 시작된다."
                ],
                background: IMAGE_URLS.FORBIDDEN_ALTAR,
                character: IMAGE_URLS.BELENA_BASE,
                choices: [{ text: "다음", next: "belena_confession_dialogue_final" }]
            },
            belena_confession_dialogue_final: {
                speaker: "벨레나",
                text: [
                    "있잖아... 나 사실 너를 탐하고 있어. 너에게 미쳐버릴 것 같아!",
                    "너의 모든 것을 나의 것으로 만들고 싶어!",
                    "처음 만났을 때부터 너의 영혼에 끌렸어. 이제는... 더 깊은 지배를 원해.",
                    "너의 모든 감각을 나의 것으로..."
                ],
                background: IMAGE_URLS.FORBIDDEN_ALTAR,
                character: IMAGE_URLS.BELENA_BASE,
                choices: [
                    { text: "나도 당신을 원해! 당신의 모든 것을 탐할게! (그녀의 지배에 복종한다)", effects: { belenaDominance: 38 + AFFECTION_BONUS }, next: "belena_happy_ending_illust_final" },
                    { text: "당신의 지배는 부담스러워. 이 유혹을 거부한다 (자유를 갈망한다)", effects: { belenaDominance: -50 }, next: "belena_bad_ending_epilogue" }
                ]
            },
            belena_happy_ending_illust_final: {
                speaker: "벨레나",
                text: [
                    "정말? 다행이군... 나만의 뜨거운 밤이 아니었구나!",
                    "이제 너는 나의 가장 귀한 소장품이 될 것이다.",
                    "앞으로 우리 영원히 함께 지배하자! 밤마다... 나의 옆에서...",
                    "나의 소장품이 되어라. 나의 모든 것을 느껴라."
                ],
                background: IMAGE_URLS.FORBIDDEN_ALTAR,
                character: null,
                fullscreen: IMAGE_URLS.BELENA_CONFESSION_CUT,
                illustKey: "BELENA_CONFESSION_CUT",
                choices: [{ text: "다음", next: "belena_happy_ending_epilogue" }]
            },
            belena_happy_ending_epilogue: {
                speaker: "내레이션",
                text: [
                    "벨레나와 함께하는 매일매일이 마치 뜨거운 꿈 같았다.",
                    "그녀의 지배는 나의 모든 것을 채웠고, 우리는 함께 금지된 마법을 탐하며 영원한 밤을 보냈다.",
                    "나는 그녀의 가장 귀한 소장품이 되었다.",
                    "그녀의 차가운 손길이 나의 모든 것을 지배했다."
                ],
                background: IMAGE_URLS.BELENA_COLLECTION_END,
                character: null,
                choices: [{ text: "엔딩 보기", next: "belena_happy_ending" }]
            },
            belena_happy_ending: {
                ending: { title: "해피 엔딩: 벨레나의 영원한 지배", text: "벨레나에게 완전 지배당하는 운명. 그녀의 가장 귀한 소장품이 되어 영원히 행복하세요! 그녀의 지배 아래서..." },
                background: IMAGE_URLS.BELENA_HAPPY_END,
                illustKey: "BELENA_HAPPY_END"
            },
            // 벨레나 에로 엔딩 에피소드
            belena_erotic_ending_epilogue: {
                speaker: "내레이션",
                text: [
                    "그녀의 차가운 손길이 나의 온몸을 탐닉했다.",
                    "벨레나의 지배는 단순한 복종이 아닌, 영혼을 뒤흔드는 쾌락으로 변모했다.",
                    "그녀의 마력이 나의 모든 감각을 깨웠고,",
                    "우리는 금단의 밤 속에서 서로의 욕망을 끝없이 탐했다.",
                    "나는 그녀의 가장 깊은 곳에 속박된 존재가 되었다.",
                    "영원히 벗어날 수 없는 쾌락의 굴레 속에서..."
                ],
                background: IMAGE_URLS.BELENA_EROTIC_END,
                character: null,
                choices: [{ text: "엔딩 보기", next: "belena_erotic_ending" }]
            },
            belena_erotic_ending: {
                ending: { title: "에로 엔딩: 벨레나의 금단의 쾌락", text: "벨레나의 지배 아래, 당신은 영원히 그녀의 육체적, 정신적 노예가 되었다. 끝없는 쾌락 속에서 그녀의 모든 것을 탐닉하라." },
                background: IMAGE_URLS.BELENA_EROTIC_END,
                illustKey: "BELENA_EROTIC_END"
            },
            belena_bad_ending_epilogue: {
                speaker: "내레이션",
                text: [
                    "벨레나의 차가운 미소는 더 이상 나를 향하지 않았다.",
                    "그녀의 지배를 거부한 대가는 혹독했다.",
                    "나의 마력은 쇠퇴했고, 나는 그녀를 놓친 아픔 속에서 어둠을 헤매었다.",
                    "그녀의 그림자가 나를 덮쳤다. 나는 그녀의 기억 속에서 지워졌다."
                ],
                background: IMAGE_URLS.BELENA_BAD_END,
                character: null,
                choices: [{ text: "엔딩 보기", next: "belena_bad_ending" }]
            },
            belena_bad_ending: {
                ending: { title: "배드 엔딩: 잃어버린 지배", text: "벨레나의 지배를 외면한 당신, 그녀와의 관계는 돌이킬 수 없게 되었다. 어둠 속에서 방황하라. 영원히..." },
                background: IMAGE_URLS.BELENA_BAD_END,
                illustKey: "BELENA_BAD_END"
            },

            // --- 릴리아 루트 ---
            // 릴리아 해피/에로 엔딩 선택지 씬
            lilia_happy_or_erotic_choice: {
                speaker: "내레이션",
                text: [
                    "릴리아의 매혹적인 눈빛이 나를 유혹한다.",
                    "그녀의 손길이 나의 영혼을 어루만지고,",
                    "이 밤, 그녀와 어떤 결말을 맞이할 것인가?",
                    "영원한 사랑인가, 아니면 탐닉의 밤인가?"
                ],
                background: IMAGE_URLS.LILIA_GARDEN_CUT,
                character: IMAGE_URLS.LILIA_BASE,
                choices: [
                    { text: "영원한 환상을 선택한다 (일반 해피 엔딩)", next: "lilia_confession_scene" },
                    { text: "탐닉의 밤을 탐한다 (에로 엔딩)", next: "lilia_erotic_ending_epilogue" }
                ]
            },
            lilia_confession_scene: {
                speaker: "내레이션",
                text: [
                    "릴리아와의 관계는 이성적인 신뢰를 넘어선 치명적인 유혹으로 깊어졌다.",
                    "그녀의 나른한 눈빛이 나를 유혹한다.",
                    "어느 날 밤, 릴리아가 나를 은월의 정원으로 불러낸다.",
                    "그곳에서 그녀의 마법이 나를 감싼다. 금지된 유혹의 밤이 시작된다."
                ],
                background: IMAGE_URLS.LILIA_GARDEN_CUT,
                character: IMAGE_URLS.LILIA_BASE,
                choices: [{ text: "다음", next: "lilia_confession_dialogue_final" }]
            },
            lilia_confession_dialogue_final: {
                speaker: "릴리아",
                text: [
                    "당신과 함께 금지된 마법을 탐하면서 많은 것을 배웠어요.",
                    "그리고 당신에게서 더 많은 것을 원하게 됐죠. 당신의 모든 것을...",
                    "이 감정이... 사랑을 넘어선 집착이라고 생각해요.",
                    "당신을 영원히 소유하고 싶어요. 나의 품에서 벗어날 수 없을 거예요.",
                    "저와 함께 영원한 밤을 만들어가지 않겠어요?",
                    "당신의 모든 것을 저에게 주세요. 나의 쾌락을 느껴봐요."
                ],
                background: IMAGE_URLS.LILIA_GARDEN_CUT,
                character: IMAGE_URLS.LILIA_BASE,
                choices: [
                    { text: "릴리아의 유혹을 받아들인다. 그녀의 어둠에 빠져든다 (금단의 쾌락을 탐한다)", effects: { liliaSeduction: 38 + AFFECTION_BONUS }, next: "lilia_happy_ending_illust_final" },
                    { text: "당신의 유혹은 너무 위험해. 그녀의 손을 놓는다 (이성을 지키려 한다)", effects: { liliaSeduction: -50 }, next: "lilia_bad_ending_epilogue" }
                ]
            },
            lilia_happy_ending_illust_final: {
                speaker: "릴리아",
                text: [
                    "정말 기뻐요. 당신이라면... 어떤 금지된 마법이라도 함께 헤쳐나갈 수 있을 거예요.",
                    "그리고 어떤 유혹도... 나의 품에서...",
                    "저의 모든 것을 당신에게 바칠게요. 당신의 영원한 환상이 될 준비가 되어 있어요.",
                    "나의 쾌락을 느껴봐요."
                ],
                background: IMAGE_URLS.LILIA_GARDEN_CUT,
                character: null,
                fullscreen: IMAGE_URLS.LILIA_CONFESSION_CUT,
                illustKey: "LILIA_CONFESSION_CUT",
                choices: [{ text: "다음", next: "lilia_happy_ending_epilogue" }]
            },
            lilia_happy_ending_epilogue: {
                speaker: "내레이션",
                text: [
                    "릴리아와 나는 서로의 가장 든든하고 치명적인 파트너가 되었다.",
                    "그녀의 금지된 마법과 나의 뜨거운 욕망이 만나,",
                    "우리는 영원한 환상 속에서 눈부신 밤을 보냈다.",
                    "우리의 사랑은 견고한 유혹 위에 피어났다.",
                    "나는 그녀의 영원한 환상이 되었다. 그녀의 손길이 나의 모든 것을 탐했다."
                ],
                background: IMAGE_URLS.LILIA_ETERNAL_END,
                character: null,
                choices: [{ text: "엔딩 보기", next: "lilia_happy_ending" }]
            },
            lilia_happy_ending: {
                ending: { title: "해피 엔딩: 릴리아의 영원한 환상", text: "릴리아와 함께 금지된 마법과 사랑 모두에서 뜨거운 성공을 거두세요! 당신은 그녀의 영원한 환상이다. 영원히..." },
                background: IMAGE_URLS.LILIA_HAPPY_END,
                illustKey: "LILIA_HAPPY_END"
            },
            // 릴리아 에로 엔딩 에피소드
            lilia_erotic_ending_epilogue: {
                speaker: "내레이션",
                text: [
                    "릴리아의 연무 마법이 나의 모든 감각을 마비시키고,",
                    "그녀의 유혹은 영혼 깊숙이 파고들었다.",
                    "금지된 마법의 쾌락 속에서 우리는 서로의 몸과 영혼을 탐닉했다.",
                    "그녀의 붉은 문신이 나의 피부에 닿을 때마다 전율이 흘렀고,",
                    "나는 그녀의 어둠 속에서 영원히 헤어나올 수 없는 쾌락의 노예가 되었다.",
                    "밤은 끝없이 이어졌다."
                ],
                background: IMAGE_URLS.LILIA_EROTIC_END,
                character: null,
                choices: [{ text: "엔딩 보기", next: "lilia_erotic_ending" }]
            },
            lilia_erotic_ending: {
                ending: { title: "에로 엔딩: 릴리아의 탐닉의 밤", text: "릴리아의 금지된 유혹 아래, 당신은 영원히 그녀의 쾌락 속에서 탐닉하게 되었다. 끝없는 밤의 유혹을 즐겨라." },
                background: IMAGE_URLS.LILIA_EROTIC_END,
                illustKey: "LILIA_EROTIC_END"
            },
            lilia_bad_ending_epilogue: {
                speaker: "내레이션",
                text: [
                    "릴리아의 차가운 시선은 나를 위축시켰다.",
                    "그녀의 유혹을 거부한 대가는 혹독했다.",
                    "나의 마력은 쇠퇴했고, 나는 그녀를 놓친 아픔 속에서 어둠을 헤매었다.",
                    "그녀의 냉정한 판단이 옳았음을 인정해야 했다. 외로운 밤이 영원히 계속된다."
                ],
                background: IMAGE_URLS.LILIA_BAD_END,
                character: null,
                choices: [{ text: "엔딩 보기", next: "lilia_bad_ending" }]
            },
            lilia_bad_ending: {
                ending: { title: "배드 엔딩: 깨진 유혹", text: "릴리아의 치명적인 마음을 저버린 당신, 그녀와의 관계는 회복 불능이 되었다. 영원히 어둠 속에서 방황하라." },
                background: IMAGE_URLS.LILIA_BAD_END,
                illustKey: "LILIA_BAD_END"
            },

            // --- 셀린 루트 ---
            // 셀린 해피/에로 엔딩 선택지 씬
            celine_happy_or_erotic_choice: {
                speaker: "내레이션",
                text: [
                    "셀린의 순수한 눈빛이 나를 유혹한다.",
                    "그녀의 따뜻한 손길이 나의 영혼을 어루만지고,",
                    "이 밤, 그녀와 어떤 결말을 맞이할 것인가?",
                    "따뜻한 사랑인가, 아니면 순수의 타락인가?"
                ],
                background: IMAGE_URLS.SACRED_GROVE,
                character: IMAGE_URLS.CELINE_BASE,
                choices: [
                    { text: "따뜻한 미래를 선택한다 (일반 해피 엔딩)", next: "celine_confession_scene" },
                    { text: "순수의 타락을 탐한다 (에로 엔딩)", next: "celine_erotic_ending_epilogue" }
                ]
            },
            celine_confession_scene: {
                speaker: "내레이션",
                text: [
                    "셀린과의 관계는 조용하지만 깊은 순수함으로 발전했다.",
                    "그녀의 맑은 눈빛 뒤에 숨겨진 욕망이 나를 유혹한다.",
                    "어느 날 밤, 셀린이 나를 신성한 숲으로 불러낸다.",
                    "그곳에서 그녀의 치유 마법이 나를 감싼다. 순수한 사랑의 밤이 시작된다."
                ],
                background: IMAGE_URLS.SACRED_GROVE,
                character: IMAGE_URLS.CELINE_BASE,
                choices: [{ text: "다음", next: "celine_confession_dialogue_final" }]
            },
            celine_confession_dialogue_final: {
                speaker: "셀린",
                text: [
                    "저... 사실은... 당신을 사랑해요. 당신에게 미쳐버릴 것 같아요.",
                    "저의 모든 것을 바치고 싶어요.",
                    "처음에는 그냥 동료라고 생각했는데... 당신의 모든 것이 저를 사로잡았어요.",
                    "저의 순수함을 당신에게 바칠게요.",
                    "점점 더 당신에게 의지하게 됐어요. 당신 없이는 살 수 없어요.",
                    "저의 모든 순수함을 당신에게 바칠게요. 저를 당신의 것으로 만들어주세요."
                ],
                background: IMAGE_URLS.SACRED_GROVE,
                character: IMAGE_URLS.CELINE_BASE,
                choices: [
                    { text: "셀린의 고백을 받아들인다. 그녀의 순수함에 빠져든다 (따뜻한 사랑을 원한다)", effects: { celinePurity: 38 + AFFECTION_BONUS }, next: "celine_happy_ending_illust_final" },
                    { text: "미안하지만, 친구로 지내고 싶어. 그녀의 순수함을 지켜준다 (고독을 택한다)", effects: { celinePurity: -50 }, next: "celine_bad_ending_epilogue" }
                ]
            },
            celine_happy_ending_illust_final: {
                speaker: "셀린",
                text: [
                    "정말... 정말 고마워요. 당신은 저의 모든 것이에요. 저의 빛이에요.",
                    "당신과 함께라면... 뭐든지 할 수 있을 것 같아요. 영원히... 나의 순수한 사랑을... 나의 모든 것을 받아주세요."
                ],
                background: IMAGE_URLS.SACRED_GROVE,
                character: null,
                fullscreen: IMAGE_URLS.CELINE_MARRIAGE,
                illustKey: "CELINE_MARRIAGE",
                choices: [{ text: "다음", next: "celine_happy_ending_epilogue" }]
            },
            celine_happy_ending_epilogue: {
                speaker: "내레이션",
                text: [
                    "수줍음 많던 셀린은 나의 옆에서 점차 뜨겁게 빛났다.",
                    "우리는 서로의 부족함을 채워주며 깊은 순수함의 사랑을 키워나갔다.",
                    "그녀의 맑은 미소 하나하나가 나의 삶을 채웠다.",
                    "나는 그녀의 따뜻한 미래가 되었다. 그녀의 순수한 손길이 나의 모든 것을 치유했다."
                ],
                background: IMAGE_URLS.CELINE_EMOTION_END,
                character: null,
                choices: [{ text: "엔딩 보기", next: "celine_happy_ending" }]
            },
            celine_happy_ending: {
                ending: { title: "해피 엔딩: 셀린의 따뜻한 미래", text: "셀린과 함께 서로를 탐하며 행복한 미래를 만들어가세요! 당신은 그녀의 영원한 빛이다. 영원히..." },
                background: IMAGE_URLS.CELINE_HAPPY_END,
                illustKey: "CELINE_HAPPY_END"
            },
            // 셀린 에로 엔딩 에피소드
            celine_erotic_ending_epilogue: {
                speaker: "내레이션",
                text: [
                    "셀린의 순수한 마력이 나의 영혼을 정화하는 동시에,",
                    "그녀의 따뜻한 손길은 나의 가장 깊은 욕망을 일깨웠다.",
                    "순수함과 관능이 뒤섞인 금단의 쾌락 속에서,",
                    "우리는 서로의 몸과 영혼을 탐닉했다.",
                    "그녀의 맑은 눈동자가 욕망으로 물들어갈 때,",
                    "나는 진정한 순수의 타락을 경험했다. 이 밤은 영원히 끝나지 않을 것이다."
                ],
                background: IMAGE_URLS.CELINE_EROTIC_END,
                character: null,
                choices: [{ text: "엔딩 보기", next: "celine_erotic_ending" }]
            },
            celine_erotic_ending: {
                ending: { title: "에로 엔딩: 셀린의 순수의 타락", text: "셀린의 순수한 마음을 타락시키며, 당신은 그녀와 금단의 쾌락 속에서 영원히 탐닉하게 되었다. 순수함과 욕망의 경계를 허물어라." },
                background: IMAGE_URLS.CELINE_EROTIC_END,
                illustKey: "CELINE_EROTIC_END"
            },
            celine_bad_ending_epilogue: {
                speaker: "내레이션",
                text: [
                    "셀린은 나를 피하기 시작했다.",
                    "그녀의 순수한 마음을 외면한 대가는 고독이었다.",
                    "나의 마력은 쇠퇴했고, 나는 그녀와의 어색한 침묵 속에서 죄책감을 느꼈다.",
                    "밤은 더욱 외로워졌다. 나는 그녀의 기억 속에서 희미해졌다."
                ],
                background: IMAGE_URLS.CELINE_BAD_END,
                character: null,
                choices: [{ text: "엔딩 보기", next: "celine_bad_ending" }]
            },
            celine_bad_ending: {
                ending: { title: "배드 엔딩: 멀어진 순수", text: "셀린의 순수한 마음을 외면한 당신, 그녀와의 관계는 멀어지고 말았다. 영원히 고독하라." },
                background: IMAGE_URLS.CELINE_BAD_END,
                illustKey: "CELINE_BAD_END"
            },

            // --- 트루 엔딩 (세 여인과 운명) ---
            true_ending_judgment_sequence_start: { // NEW: 심판 시퀀스 시작 씬
                speaker: "내레이션",
                text: [
                    "나는 세 여인 모두와 뜨거운 관계를 유지했으며,",
                    "마법력 또한 뛰어난 성과를 보여주었다. 나의 매력은 그들을 모두 사로잡았다.",
                    "어느 날 밤, 세 여인이 나를 금단의 제단으로 불러낸다.",
                    "그들의 눈빛은 욕망으로 가득하다. 운명의 심판이 시작된다."
                ],
                background: IMAGE_URLS.FORBIDDEN_ALTAR,
                character: null,
                // `fullscreen`을 배열로 전달하여 순차적으로 표시
                fullscreen: [
                    IMAGE_URLS.THREE_WITCHES_JUDGMENT_1,
                    IMAGE_URLS.THREE_WITCHES_JUDGMENT_2,
                    IMAGE_URLS.THREE_WITCHES_JUDGMENT_3
                ],
                illustsSequenceStart: true, // This flag indicates the start of a multi-illust sequence
                illustKey: ["THREE_WITCHES_JUDGMENT_1", "THREE_WITCHES_JUDGMENT_2", "THREE_WITCHES_JUDGMENT_3"], // All keys for gallery
                // 각 일러스트에 대한 대화 내용을 배열로 전달
                speaker: ["벨레나", "릴리아", "셀린"],
                text: [
                    ["운명은 너를 내게 바쳤다. 이제 너는 나의 것이다. 나의 지배를 받아들여라. 너의 모든 것을 나에게 바쳐라."],
                    ["하지만 선택은 네가 해야 해. 나의 유혹에 빠져들 것인가? 영원한 밤을 원한다면... 나의 쾌락을 느껴봐."],
                    ["우리 모두의 마음을 시험할 거야. 너의 순수한 마음을 보여줘. 우리의 사랑을 믿는다면... 나의 모든 것을 받아줘."]
                ],
                choices: [{ text: "다음", next: "true_ending_choice" }] // 모든 일러스트 표시 후 최종 선택지로 이동
            },
            true_ending_choice: {
                speaker: "내레이션",
                text: [
                    "세 여인이 동시에 나에게 뜨거운 고백을 했다! 그들의 욕망이 나를 향한다.",
                    "나는 어떤 선택을 할 것인가? 이 금단의 유혹에 빠져들 것인가?",
                    "아니면 모두를 품을 것인가?"
                ],
                background: IMAGE_URLS.FORBIDDEN_ALTAR,
                character: null,
                choices: [
                    { text: "벨레나를 선택한다. 그녀의 지배에 복종한다 (가장 강한 쾌락을 원한다)", effects: { belenaDominance: 53 + AFFECTION_BONUS, liliaSeduction: -15, celinePurity: -15 }, next: "belena_happy_or_erotic_choice" },
                    { text: "릴리아를 선택한다. 그녀의 치명적인 유혹에 응한다 (금단의 쾌락을 원한다)", effects: { liliaSeduction: 53 + AFFECTION_BONUS, belenaDominance: -15, celinePurity: -15 }, next: "lilia_happy_or_erotic_choice" },
                    { text: "셀린을 선택한다. 그녀의 순수한 사랑을 받아들인다 (따뜻한 사랑을 원한다)", effects: { celinePurity: 53 + AFFECTION_BONUS, belenaDominance: -15, liliaSeduction: -15 }, next: "celine_happy_or_erotic_choice" },
                    { text: "모두와 함께하고 싶다고 말한다. 금단의 하렘을 건설한다 (모든 쾌락을 탐한다)", effects: { belenaDominance: 20 + AFFECTION_BONUS, liliaSeduction: 20 + AFFECTION_BONUS, celinePurity: 20 + AFFECTION_BONUS }, next: "true_ending_contract_epilogue" } // 트루 엔딩 호감도 추가
                ]
            },
            true_ending_contract_epilogue: {
                speaker: "내레이션",
                text: [
                    "세 명의 아름다운 여인들과 함께하는 삶은 꿈만 같았다.",
                    "각각의 매력이 나의 삶을 다채로운 욕망으로 채워주었고,",
                    "우리는 서로를 탐하고 사랑하며 영원한 밤을 약속했다.",
                    "이 모든 것이 현실이라니, 믿기지 않는 뜨거운 나날들이었다.",
                    "나는 그들의 모든 것이 되었다."
                ],
                background: IMAGE_URLS.TRUE_CONTRACT_END,
                character: null,
                choices: [
                    { text: "엔딩 보기", next: "true_ending_contract" },
                    { text: "에로 에필로그 확인하기", next: "harem_erotic_start" } // NEW: 에로 엔딩 버튼 추가
                ]
            },
            true_ending_contract: {
                ending: { title: "트루 엔딩: 운명을 함께하는 계약", text: "세 여인과 함께 영원히 뜨거운 밤을 보내세요! 당신은 그들의 모든 것이 되었다. 영원히..." },
                background: IMAGE_URLS.TRUE_CONTRACT_END,
                illustKey: "TRUE_CONTRACT_END"
            },

            // --- NEW: 하렘 에로 에필로그 (수정됨) ---
            harem_erotic_start: {
                speaker: "내레이션",
                text: [
                    "계약의 밤은 깊어지고, 벨레나가 나를 기다리고 있었다.",
                    "그녀의 차가운 눈빛은 뜨거운 욕망으로 가득 차 있었고, 나를 보자마자 다가왔다."
                ],
                background: IMAGE_URLS.HAREM_EROTIC_BELENA,
                character: null,
                fullscreen: IMAGE_URLS.HAREM_EROTIC_BELENA,
                illustKey: "HAREM_EROTIC_BELENA",
                choices: [{ text: "다음", next: "harem_erotic_belena_dialogue_1" }]
            },
            harem_erotic_belena_dialogue_1: {
                speaker: "벨레나",
                text: [
                    "내 사랑, 오늘 밤은 나만의 지배를 온전히 느껴봐. 너의 모든 것을 나의 것으로 만들 테니.",
                    "두려워하지 마. 이 밤은 우리 둘만의 것이니까. 너의 모든 것을 바쳐라."
                ],
                background: IMAGE_URLS.HAREM_EROTIC_BELENA,
                character: null,
                fullscreen: IMAGE_URLS.HAREM_EROTIC_BELENA,
                illustKey: "HAREM_EROTIC_BELENA",
                choices: [{ text: "다음", next: "harem_erotic_lilia_joins" }]
            },
            harem_erotic_lilia_joins: {
                speaker: "내레이션",
                text: [
                    "그녀의 지배적인 손길이 나를 덮치려는 순간, 문이 열리고 릴리아가 모습을 드러냈다.",
                    "그녀는 나른한 미소를 지으며, 벨레나의 옆에 다가섰다."
                ],
                background: IMAGE_URLS.HAREM_EROTIC_BELENA_LILIA,
                character: null,
                fullscreen: IMAGE_URLS.HAREM_EROTIC_BELENA_LILIA,
                illustKey: "HAREM_EROTIC_BELENA_LILIA",
                choices: [{ text: "다음", next: "harem_erotic_lilia_dialogue" }]
            },
            harem_erotic_lilia_dialogue: {
                speaker: "릴리아",
                text: [
                    "어머, 벨레나. 좋은 건 혼자서만 즐기려 했나요? 나도 당신의 쾌락에 동참하고 싶어요.",
                    "괜찮아요, 나의 사랑. 이 밤은 우리 셋의 것이 될 테니까. 나의 유혹을 느껴봐요."
                ],
                background: IMAGE_URLS.HAREM_EROTIC_BELENA_LILIA,
                character: null,
                fullscreen: IMAGE_URLS.HAREM_EROTIC_BELENA_LILIA,
                illustKey: "HAREM_EROTIC_BELENA_LILIA",
                choices: [{ text: "다음", next: "harem_erotic_belena_lilia_aftermath" }]
            },
            harem_erotic_belena_lilia_aftermath: {
                speaker: "내레이션",
                text: [
                    "두 마녀의 뜨거운 유혹이 나를 덮쳤다. 벨레나의 지배와 릴리아의 쾌락이 뒤섞여...",
                    "나는 이 금지된 밤의 주인공이 되었다. 밤은 끝없이 뜨거워졌다.",
                    "세상이 끝날 것만 같은 뜨거운 밤이 지나고, 아침이 찾아왔다."
                ],
                background: IMAGE_URLS.HAREM_EROTIC_BELENA_LILIA,
                character: null,
                fullscreen: IMAGE_URLS.HAREM_EROTIC_BELENA_LILIA,
                illustKey: "HAREM_EROTIC_BELENA_LILIA",
                choices: [{ text: "다음", next: "harem_erotic_celine_seduction" }]
            },
            harem_erotic_celine_seduction: {
                speaker: "내레이션",
                text: [
                    "전날 밤의 여운이 가시지 않은 채, 셀린이 내 방으로 들어왔다.",
                    "그녀는 내 앞에 수줍게 섰지만, 그 눈빛은 평소와 달리 질투와 뜨거운 욕망으로 가득 차 있었다.",
                    "그녀는 천천히 옷을 벗으며, 그녀의 순수한 몸을 드러냈다."
                ],
                background: IMAGE_URLS.HAREM_EROTIC_CELINE,
                character: null,
                fullscreen: IMAGE_URLS.HAREM_EROTIC_CELINE,
                illustKey: "HAREM_EROTIC_CELINE",
                choices: [{ text: "다음", next: "harem_erotic_celine_dialogue" }]
            },
            harem_erotic_celine_dialogue: {
                speaker: "셀린",
                text: [
                    "어제 밤... 두 사람과 함께 하셨다고 들었어요. 저... 저는... 질투가 나요...",
                    "저도... 당신의 모든 것을 탐하고 싶어요. 저의 순수한 사랑을 보여줄게요...",
                    "저의 모든 것을... 받아주세요. 이 밤은... 저와 함께... 뜨거워져 봐요."
                ],
                background: IMAGE_URLS.HAREM_EROTIC_CELINE,
                character: null,
                fullscreen: IMAGE_URLS.HAREM_EROTIC_CELINE,
                illustKey: "HAREM_EROTIC_CELINE",
                choices: [{ text: "다음", next: "harem_final_erotic_epilogue" }]
            },
            harem_final_erotic_epilogue: {
                speaker: "내레이션",
                text: [
                    "그녀의 수줍은 유혹은 나의 이성을 마비시켰다. 순수한 욕망이 나를 덮쳤다.",
                    "셀린의 따뜻한 손길은 뜨거운 쾌락으로 변했고, 우리는 서로의 몸과 영혼을 끝없이 탐닉했다.",
                    "그녀의 순수함이 타락하는 순간, 나는 진정한 욕망의 밤을 맞이했다.",
                    "세 마녀와의 뜨거운 밤은 영원히 끝나지 않았다. 이 모든 것이 현실이었다.",
                    "영원히 그들의 품 속에서..."
                ],
                background: IMAGE_URLS.HAREM_FINAL_EROTIC,
                character: null,
                choices: [{ text: "에로 엔딩 보기", next: "harem_final_erotic" }]
            },
            harem_final_erotic: {
                ending: { title: "에로 엔딩: 영원히 타락한 밤", text: "세 마녀의 사랑을 모두 차지한 당신, 그들과 함께 영원히 끝나지 않는 뜨거운 밤을 보내게 된다. 축복받은 하렘의 왕이여, 모든 것을 탐닉하라!" },
                background: IMAGE_URLS.HAREM_FINAL_EROTIC,
                illustKey: "HAREM_FINAL_EROTIC",
                onEnter: showPasswordPopup
            },

            // --- 벨레나 NTR 엔딩 에피소드 (놓쳐버린 유혹) ---
            belena_ntr_ending_episode: {
                speaker: "내레이션",
                text: [
                    "어느새 계절이 바뀌고, 나는 마녀들의 세계에 완전히 익숙해져 있었다.",
                    "바쁜 마법 연구 속에서도 가끔 문득, 벨레나의 차가운 미소와 지배적인 눈빛이 떠오르곤 했다. 그녀를 놓친 후회와 함께...",
                    "그러던 어느 날 밤, 폐허가 된 성의 연회장에서 익숙한 뒷모습을 발견했다. 벨레나였다.",
                    "그녀를 부르려던 찰나, 그녀가 뒤돌아섰고, 나의 눈은 자연스럽게 그녀의 왼손으로 향했다.",
                    "그곳에는… 빛나는 마법 각인이 새겨져 있었다.",
                    "나의 심장이 차갑게 식어버린다. 나의 지배욕은 산산조각 났다."
                ],
                background: IMAGE_URLS.BELENA_NTR_ILLUST,
                character: null,
                fullscreen: IMAGE_URLS.BELENA_NTR_ILLUST,
                illustKey: "BELENA_NTR_ILLUST",
                choices: [{ text: "다음", next: "belena_ntr_dialogue_1" }]
            },
            belena_ntr_dialogue_1: {
                speaker: "벨레나",
                text: [
                    "어? 너였나? 오랜만이군. 여기서 다 만나다니? 잘 지냈나? 왜 그렇게 놀란 표정이지?",
                    "나의 새로운 계약자를 보았나?"
                ],
                background: IMAGE_URLS.BELENA_NTR_ILLUST,
                character: null,
                fullscreen: IMAGE_URLS.BELENA_NTR_ILLUST,
                illustKey: "BELENA_NTR_ILLUST",
                choices: [{ text: "다음", next: "belena_ntr_dialogue_2" }]
            },
            belena_ntr_dialogue_2: {
                speaker: "주인공",
                text: ["벨레나! 정말 오랜만이다. 잘 지냈어? 어… 그 각인…?"],
                background: IMAGE_URLS.BELENA_NTR_ILLUST,
                character: null,
                fullscreen: IMAGE_URLS.BELENA_NTR_ILLUST,
                illustKey: "BELENA_NTR_ILLUST",
                choices: [{ text: "다음", next: "belena_ntr_dialogue_3" }]
            },
            belena_ntr_dialogue_3: {
                speaker: "벨레나",
                text: [
                    "아, 이거? 그래! 나는 새로운 계약을 맺었지!",
                    "다음 달이면 완전한 지배가 시작돼! 너는 놓쳤지만...",
                    "사실… 너에게 제일 먼저 말해주고 싶었어.",
                    "네가 나를 많이 아껴주고, 또 나도 너에게 흥미를 느꼈었거든.",
                    "하지만 너는 너무 많은 존재에게 다정했어.",
                    "나의 지배를 온전히 받아들이지 못했지."
                ],
                background: IMAGE_URLS.BELENA_NTR_ILLUST,
                character: null,
                fullscreen: IMAGE_URLS.BELENA_NTR_ILLUST,
                illustKey: "BELENA_NTR_ILLUST",
                choices: [{ text: "다음", next: "belena_ntr_dialogue_4" }]
            },
            belena_ntr_dialogue_4: {
                speaker: "벨레나",
                text: [
                    "근데… 너는 모두에게 너무 상냥해서… 나는 네 옆에 있을 수 없었어.",
                    "네가 나한테만 특별한 존재가 아니라는 걸 알았을 때… 나의 지배욕이 식어버렸거든.",
                    "너는 나에게 온전히 복종하지 않았어."
                ],
                background: IMAGE_URLS.BELENA_NTR_ILLUST,
                character: null,
                fullscreen: IMAGE_URLS.BELENA_NTR_ILLUST,
                illustKey: "BELENA_NTR_ILLUST",
                choices: [{ text: "다음", next: "belena_ntr_dialogue_5" }]
            },
            belena_ntr_dialogue_5: {
                speaker: "벨레나",
                text: [
                    "지금 나의 계약자는… 나에게만 오직 나에게만 복종하는 존재야. 그래서 이 존재라면 괜찮겠다 싶었지.",
                    "나를 온전히 탐해줄 존재... 너와는 다른..."
                ],
                background: IMAGE_URLS.BELENA_NTR_ILLUST,
                character: null,
                fullscreen: IMAGE_URLS.BELENA_NTR_ILLUST,
                illustKey: "BELENA_NTR_ILLUST",
                choices: [{ text: "다음", next: "belena_ntr_dialogue_6" }]
            },
            belena_ntr_dialogue_6: {
                speaker: "벨레나",
                text: [
                    "이 각인, 아름답지? 나는 너무 행복해! 정말 꿈같아! 너도 어때? 새로운 지배자를 만났어? 나중에 꼭 소개해 줘!",
                    "우리 모두 영원히 행복하게 지배하자! 너는 이제 나의 기억 속에서 사라질 존재일 뿐이다."
                ],
                background: IMAGE_URLS.BELENA_NTR_ILLUST,
                character: null,
                fullscreen: IMAGE_URLS.BELENA_NTR_ILLUST,
                illustKey: "BELENA_NTR_ILLUST",
                choices: [{ text: "다음", next: "belena_ntr_ending_final_narration" }]
            },
            belena_ntr_ending_final_narration: {
                speaker: "내레이션",
                text: [
                    "벨레나의 뒷모습이 멀어지고, 나는 텅 빈 연회장에 홀로 남았다.",
                    "그녀의 말 한마디 한마디가 가슴에 비수처럼 박혔다.",
                    "모두에게 상냥했던 나의 모습이, 결국 그녀를 나의 지배에서 멀어지게 만들었다는 것을 깨달았다.",
                    "그녀의 행복을 빌어줘야 할까? 아니면… 놓쳐버린 뜨거운 지배에 대한 후회를 해야 할까?",
                    "차가운 밤공기만이 나를 감쌌다. 나의 밤은 외로움으로 가득 찼다.",
                    "그녀의 지배는 영원히 나의 것이 될 수 없었다."
                ],
                background: IMAGE_URLS.BELENA_NTR_FINAL_END,
                character: null,
                ending: { title: "배드 엔딩: 놓쳐버린 유혹", text: "벨레나는 당신의 다정함 때문에 떠나갔다. 그녀의 행복을 빌어주자. 당신의 밤은 외로울 것이다. 영원히..." },
                illustKey: "BELENA_NTR_FINAL_END"
            },

            // --- 일반 배드 엔딩 및 실패 엔딩 ---
            failure_ending_epilogue: {
                speaker: "내레이션",
                text: [
                    "결국 나는 마녀들과 엘프 치유사의 세계에 완전히 적응하지 못했다.",
                    "누구와도 깊은 관계를 맺지 못했고, 마법 연구에서도 큰 성과를 내지 못했다.",
                    "외롭고 쓸쓸한 밤이 계속되었다.",
                    "다음번에는 더 나은 유혹을 시도할 수 있을까? 나의 밤은 차갑게 식어버렸다."
                ],
                background: IMAGE_URLS.FAILURE_END,
                character: null,
                choices: [{ text: "엔딩 보기", next: "failure_ending" }]
            },
            failure_ending: {
                ending: { title: "배드 엔딩: 어둠 속 방황", text: "당신의 마녀 세계 생활은 순탄치 않았다. 다음 기회를 노려보세요. 더 뜨거운 밤을 위해... 영원히..." },
                background: IMAGE_URLS.FAILURE_END,
                illustKey: "FAILURE_END"
            }
        };

        // 게임 시작 함수
        function startGame() {
            titleScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            resetGame();
            displayScene(scenes[gameState.currentScene]);
            backgroundMusic.play().catch(error => {
                console.log("Autoplay prevented:", error);
            });
        }

        // 게임 재시작 함수
        function restartGame() {
            endingScreen.style.display = 'none';
            titleScreen.style.display = 'flex';
            resetGame();
            backgroundMusic.play().catch(error => {
                console.log("Autoplay prevented:", error);
            });
        }

        // 게임 상태 초기화
        function resetGame() {
            gameState.currentScene = 'prologue';
            gameState.belenaDominance = 0;
            gameState.liliaSeduction = 0;
            gameState.celinePurity = 0;
            gameState.magicPower = 50;
            gameState.currentTextIndex = 0;
            gameState.isTyping = false;
            currentFullscreenIllustIndex = 0; // Reset global illust index
            // Reset sequence active flags for all scenes
            for (const sceneKey in scenes) {
                if (scenes[sceneKey].illustsSequenceActive !== undefined) {
                    scenes[sceneKey].illustsSequenceActive = false;
                }
            }
            updateStats();
            hideFullscreenIllust();
        }

        // 스탯 업데이트 함수
        function updateStats() {
            gameState.belenaDominance = Math.max(0, Math.min(100, gameState.belenaDominance));
            gameState.liliaSeduction = Math.max(0, Math.min(100, gameState.liliaSeduction));
            gameState.celinePurity = Math.max(0, Math.min(100, gameState.celinePurity));
            gameState.magicPower = Math.max(0, Math.min(100, gameState.magicPower));

            belenaDominanceBar.style.width = gameState.belenaDominance + '%';
            belenaDominanceValue.textContent = gameState.belenaDominance;
            liliaSeductionBar.style.width = gameState.liliaSeduction + '%';
            liliaSeductionValue.textContent = gameState.liliaSeduction;
            celinePurityBar.style.width = gameState.celinePurity + '%';
            celinePurityValue.textContent = gameState.celinePurity;
            magicPowerBar.style.width = gameState.magicPower + '%';
            magicPowerValue.textContent = gameState.magicPower;
        }

        // 마법 파편 이펙트 생성
        function createMagicSparkEffect(x, y) {
            const spark = document.createElement('div');
            spark.classList.add('magic-spark');
            spark.style.left = `${x}px`;
            spark.style.top = `${y}px`;
            magicEffectsContainer.appendChild(spark);

            spark.addEventListener('animationend', () => {
                spark.remove();
            });
        }

        // 대화 텍스트 타이핑 효과
        function typeWriter(text, element, callback) {
            let i = 0;
            element.textContent = '';
            gameState.isTyping = true;
            let currentSceneRef = scenes[gameState.currentScene];

            function type() {
                if (currentSceneRef !== scenes[gameState.currentScene]) {
                    gameState.isTyping = false;
                    return;
                }

                // Ensure text is a string before accessing length
                if (typeof text !== 'string') {
                    console.error("Error: typeWriter received non-string text:", text);
                    gameState.isTyping = false;
                    if (callback) callback();
                    return;
                }

                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    setTimeout(type, 30);
                } else {
                    gameState.isTyping = false;
                    if (callback) callback();
                }
            }
            type();
        }

        // 전체화면 일러스트 표시 (멀티 일러스트 시퀀스 처리)
        function showFullscreenIllust(illusts, dialogueContent, choices) {
            const sceneObj = scenes[gameState.currentScene];

            // Initialize or reset sequence state
            // This condition ensures currentFullscreenIllustIndex and dialogueContent.currentTextIndex
            // are reset ONLY when entering a *new* fullscreen scene (single or multi-illust).
            // It does NOT reset them when advancing to the next illust within an *already active* multi-illust sequence.
            if (!Array.isArray(illusts) || !sceneObj.illustsSequenceActive) {
                currentFullscreenIllustIndex = 0;
                dialogueContent.currentTextIndex = 0; // Always reset text index when starting a new fullscreen view
                sceneObj.illustsSequenceActive = Array.isArray(illusts); // Set to true if it's a multi-illust scene
                if (Array.isArray(illusts)) {
                    // Mark all illusts in the sequence as collected when the sequence starts
                    illusts.forEach(illustUrl => {
                        const illustKey = Object.keys(IMAGE_URLS).find(key => IMAGE_URLS[key] === illustUrl);
                        if (illustKey) {
                            markIllustAsCollected(illustKey);
                        }
                    });
                } else { // Handle single illust case
                    const illustKey = Object.keys(IMAGE_URLS).find(key => IMAGE_URLS[key] === illusts);
                    if (illustKey) {
                        markIllustAsCollected(illustKey);
                    }
                }
            } else if (Array.isArray(illusts) && currentFullscreenIllustIndex < illusts.length -1) { // Only reset text index if there are more illusts to show
                dialogueContent.currentTextIndex = 0;
            }


            fullscreenIllust.style.display = 'flex';
            fullscreenImage.src = Array.isArray(illusts) ? illusts[currentFullscreenIllustIndex] : illusts;
            fullscreenImage.classList.add('fade-in');

            const illustSpeakerName = illustDialogueDiv.querySelector('.speaker-name') || document.createElement('div');
            illustSpeakerName.className = 'speaker-name';
            illustSpeakerName.textContent = Array.isArray(dialogueContent.speaker) ? dialogueContent.speaker[currentFullscreenIllustIndex] : dialogueContent.speaker;
            
            const illustDialogueText = illustDialogueDiv.querySelector('.dialogue-text') || document.createElement('div');
            illustDialogueText.className = 'dialogue-text';
            
            illustDialogueDiv.innerHTML = '';
            illustDialogueDiv.appendChild(illustSpeakerName);
            illustDialogueDiv.appendChild(illustDialogueText);

            // Determine current text for typing effect
            const currentTextArray = Array.isArray(dialogueContent.text[0]) ? dialogueContent.text[currentFullscreenIllustIndex] : dialogueContent.text;
            const currentText = currentTextArray[dialogueContent.currentTextIndex]; // Access the string

            // Defensive check
            if (typeof currentText === 'undefined') {
                console.error("Error: currentText is undefined. Scene:", gameState.currentScene, "Illust Index:", currentFullscreenIllustIndex, "Text Index:", dialogueContent.currentTextIndex, "Text Array:", currentTextArray);
                hideFullscreenIllust();
                moveToNextScene(dialogueContent.next || 'failure_ending_epilogue');
                return;
            }

            // Clear previous click handler before setting a new one
            // This is the crucial part for preventing multiple handlers and ensuring consistent behavior
            if (currentFullscreenClickHandler) {
                fullscreenIllust.removeEventListener('click', currentFullscreenClickHandler);
            }

            currentFullscreenClickHandler = (event) => {
                // Ignore clicks on choice buttons, as they have their own handlers.
                if (event.target.classList.contains('illust-choice-button')) {
                    return;
                }

                if (gameState.isTyping) {
                    // If currently typing, simply return without doing anything
                    return;
                }
                
                // Only proceed if typing is NOT in progress
                if (dialogueContent.currentTextIndex < currentTextArray.length - 1) {  
                    dialogueContent.currentTextIndex++;
                    typeWriter(currentTextArray[dialogueContent.currentTextIndex], illustDialogueText);  
                } else if (Array.isArray(illusts) && currentFullscreenIllustIndex < illusts.length - 1) {
                    currentFullscreenIllustIndex++;
                    // No need to reset dialogueContent.currentTextIndex here, it's done at the top of showFullscreenIllust
                    showFullscreenIllust(illusts, dialogueContent, choices); // Re-call to display next illust/text
                } else {
                    fullscreenIllust.removeEventListener('click', currentFullscreenClickHandler); // Remove this specific handler
                    currentFullscreenClickHandler = null; // Clear the global reference
                    if (choices.length > 0) {
                        illustChoicesDiv.style.display = 'flex';
                        renderIllustChoices(choices); // Render choices for fullscreen illusts
                    } else {
                        hideFullscreenIllust();
                        moveToNextScene(dialogueContent.next);
                    }
                }
            };

            // Add the new event listener
            fullscreenIllust.addEventListener('click', currentFullscreenClickHandler);

            // Start typing the current text line
            typeWriter(currentText, illustDialogueText); // No callback here, click handler manages progression
        }

        // 전체화면 일러스트 숨기기
        function hideFullscreenIllust() {
            fullscreenIllust.style.display = 'none';
            fullscreenImage.src = '';
            fullscreenImage.classList.remove('fade-in');
            illustDialogueDiv.innerHTML = '';
            illustChoicesDiv.innerHTML = '';
            illustChoicesDiv.style.display = 'none';
            currentFullscreenIllustIndex = 0; // Reset index when hiding
            // Also reset the sequence active flag for the current scene
            if (scenes[gameState.currentScene]) {
                scenes[gameState.currentScene].illustsSequenceActive = false;
            }
            // Ensure the event listener is removed when hiding the fullscreen illust
            if (currentFullscreenClickHandler) {
                fullscreenIllust.removeEventListener('click', currentFullscreenClickHandler);
                currentFullscreenIllustIndex = 0; // Ensure index is reset for next sequence
                currentFullscreenClickHandler = null;
            }
        }

        // 장면 표시 함수
        function displayScene(scene) {
            if (scene.fullscreen) {
                const illustDialogueContent = {
                    speaker: scene.speaker,
                    text: scene.text,
                    currentTextIndex: 0, // This will be reset again in showFullscreenIllust, but good for clarity
                    next: scene.choices[0] ? scene.choices[0].next : null,
                    illustKey: scene.illustKey
                };
                showFullscreenIllust(scene.fullscreen, illustDialogueContent, scene.choices);
                dialogueContainer.classList.remove('dialogue-choices-active');
                dialogueBox.style.display = 'none';
                choicesContainer.style.display = 'none';
                characterImage.style.display = 'none';
                return;
            } else {
                dialogueBox.style.display = 'block';
                choicesContainer.style.display = 'none';
                dialogueContainer.classList.remove('dialogue-choices-active');
                hideFullscreenIllust(); // Ensure any lingering fullscreen is hidden
            }

            gameBackground.style.backgroundImage = `url(${scene.background})`;

            if (scene.character) {
                characterImage.src = scene.character;
                characterImage.style.display = 'block';
            } else {
                characterImage.style.display = 'none';
            }

            speakerName.textContent = scene.speaker;
            if (scene.speaker === "내레이션" || scene.speaker.includes("(쪽지)")) {
                speakerName.classList.add('narration');
                dialogueBox.classList.add('narration-style');
                dialogueBox.classList.remove('character-style');
            } else {
                speakerName.classList.remove('narration');
                dialogueBox.classList.remove('narration-style');
                dialogueBox.classList.add('character-style');
            }

            gameState.currentTextIndex = 0;
            typeWriter(scene.text[gameState.currentTextIndex], dialogueText, () => {
                // 타이핑이 완료되면 클릭 이벤트를 활성화
                dialogueBox.onclick = (event) => {
                    if (event.target.closest('.choices-container')) return;

                    // 타이핑이 진행 중일 때는 클릭을 무시하고 아무것도 하지 않음 (텍스트 완성도 안 함)
                    if (gameState.isTyping) {
                        return; // 클릭 무시
                    }
                    
                    // 타이핑이 완료된 후에만 다음 텍스트 또는 선택지로 진행
                    if (gameState.currentTextIndex < scene.text.length - 1) {  
                        gameState.currentTextIndex++;
                        typeWriter(scene.text[gameState.currentTextIndex], dialogueText);  
                    } else {
                        dialogueBox.onclick = null; // 모든 텍스트가 표시되면 클릭 핸들러 제거
                        showChoices(scene.choices);
                    }
                };
            });

            if (scene.onEnter && typeof scene.onEnter === 'function') {
                scene.onEnter();
            }
        }

        // 선택지 표시 함수
        function showChoices(choices) {
            choicesContainer.innerHTML = '';
            choicesContainer.style.display = 'block';
            dialogueContainer.classList.add('dialogue-choices-active');

            choices.forEach(choice => {
                const button = document.createElement('button');
                button.classList.add('choice-button');
                button.textContent = choice.text;
                button.onclick = () => {
                    if (choiceSound) {
                        choiceSound.currentTime = 0;
                        choiceSound.play().catch(e => console.log("Choice sound play error:", e));
                    }

                    const rect = button.getBoundingClientRect();
                    createMagicSparkEffect(rect.left + rect.width / 2, rect.top + rect.height / 2);

                    applyEffects(choice.effects);
                    moveToNextScene(choice.next);
                };
                choicesContainer.appendChild(button);
            });
        }

        // 전체화면 일러스트 내 선택지 표시 함수
        function renderIllustChoices(choices) {
            illustChoicesDiv.innerHTML = ''; // Clear previous choices
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.classList.add('illust-choice-button');
                button.textContent = choice.text;
                button.onclick = () => {
                    if (choiceSound) {
                        choiceSound.currentTime = 0;
                        choiceSound.play().catch(e => console.log("Choice sound play error:", e));
                    }
                    applyEffects(choice.effects);
                    hideFullscreenIllust(); // Hide fullscreen illust when a choice is made
                    moveToNextScene(choice.next);
                };
                illustChoicesDiv.appendChild(button);
            });
            illustChoicesDiv.style.display = 'flex'; // Make sure choices are visible
        }

        // 스탯 변화 적용 함수
        function applyEffects(effects) {
            let affectionIncreased = false;
            if (effects) {
                for (const stat in effects) {
                    if (effects[stat] > 0) {
                        const barElement = document.getElementById(stat + 'Bar');
                        if (barElement) {
                            barElement.classList.remove('sparkle');
                            void barElement.offsetWidth;
                            barElement.classList.add('sparkle');
                            barElement.addEventListener('animationend', () => {
                                barElement.classList.remove('sparkle');
                            }, { once: true });
                        }
                    }

                    if (stat.includes('Dominance') || stat.includes('Seduction') || stat.includes('Purity') && effects[stat] > 0) {
                        affectionIncreased = true;
                    }
                    gameState[stat] += effects[stat];
                }
                updateStats();

                if (affectionIncreased && affectionSound) {
                    affectionSound.currentTime = 0;
                    affectionSound.play().catch(e => console.log("Affection sound play error:", e));
                }
            }
        }

        // 다음 장면으로 이동 함수
        function moveToNextScene(nextSceneName) {
            const nextScene = scenes[nextSceneName];
            if (nextScene) {
                gameState.currentScene = nextSceneName;
                if (nextScene.ending) {
                    if (nextScene.illustKey) {
                        // If illustKey is an array, mark all of them as collected
                        if (Array.isArray(nextScene.illustKey)) {
                            nextScene.illustKey.forEach(key => markIllustAsCollected(key));
                        } else {
                            markIllustAsCollected(nextScene.illustKey);
                        }
                    }
                    showEndingScreen(nextScene.ending.title, nextScene.ending.text, nextScene.background);
                } else {
                    displayScene(nextScene);
                }
            } else {
                console.error("장면을 찾을 수 없습니다:", nextSceneName);
                showEndingScreen("게임 오류", "장면을 찾을 수 없습니다. 게임을 다시 시작합니다.", IMAGE_URLS.FAILURE_END);
            }
        }

        // 엔딩 화면 표시 함수
        function showEndingScreen(title, text, backgroundUrl) {
            gameScreen.style.display = 'none';
            endingScreen.style.display = 'flex';
            endingTitle.textContent = title;
            endingText.textContent = text;
            endingScreen.style.backgroundImage = `url(${backgroundUrl})`;
            endingScreen.style.backgroundSize = 'cover';
            endingScreen.style.backgroundPosition = 'center';
            backgroundMusic.pause();
        }

        // 갤러리 관련 함수
        function loadCollectedIllusts() {
            const savedData = localStorage.getItem(COLLECTED_ILLUSTS_KEY);
            if (savedData) {
                gameState.collectedIllusts = JSON.parse(savedData);
            } else {
                for (const key in GALLERY_ILLUST_MAP) {
                    gameState.collectedIllusts[key] = false;
                }
                saveCollectedIllusts();
            }
        }

        function saveCollectedIllusts() {
            localStorage.setItem(COLLECTED_ILLUSTS_KEY, JSON.stringify(gameState.collectedIllusts));
        }

        function markIllustAsCollected(key) {
            if (gameState.collectedIllusts[key] !== undefined) {
                gameState.collectedIllusts[key] = true;
                saveCollectedIllusts();
            }
        }

        function showGalleryScreen() {
            titleScreen.style.display = 'none';
            gameScreen.style.display = 'none';
            endingScreen.style.display = 'none';
            galleryScreen.style.display = 'flex';
            renderGallery();
        }

        function hideGalleryScreen() {
            galleryScreen.style.display = 'none';
            titleScreen.style.display = 'flex';
        }

        function renderGallery() {
            galleryGrid.innerHTML = '';
            let collectedCount = 0;
            const totalIllusts = Object.keys(GALLERY_ILLUST_MAP).length;

            for (const key in GALLERY_ILLUST_MAP) {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('gallery-item');

                const itemName = document.createElement('div');
                itemName.classList.add('item-name');
                
                if (gameState.collectedIllusts[key]) {
                    collectedCount++;
                    const img = document.createElement('img');
                    img.src = IMAGE_URLS[key];
                    img.alt = GALLERY_ILLUST_MAP[key];
                    itemDiv.appendChild(img);
                    itemName.textContent = GALLERY_ILLUST_MAP[key];
                    itemDiv.appendChild(itemName);

                    itemDiv.onclick = () => showImageOverlay(IMAGE_URLS[key], GALLERY_ILLUST_MAP[key]);
                } else {
                    itemDiv.classList.add('uncollected');
                    itemName.textContent = "";
                    itemDiv.appendChild(itemName);
                }
                galleryGrid.appendChild(itemDiv);
            }

            const percentage = totalIllusts > 0 ? Math.round((collectedCount / totalIllusts) * 100) : 0;
            progressBarFill.style.width = percentage + '%';
            progressPercentage.textContent = percentage + '%';
        }

        function showImageOverlay(imageUrl, title) {
            overlayImage.src = imageUrl;
            overlayImage.alt = title;
            galleryImageOverlay.classList.add('active');
        }

        function hideImageOverlay() {
            galleryImageOverlay.classList.remove('active');
            overlayImage.src = '';
            overlayImage.alt = '';
        }

        // Password Popup functions
        function showPasswordPopup() {
            passwordPopup.style.display = 'flex';
        }

        function hidePasswordPopup() {
            passwordPopup.style.display = 'none';
        }

        window.onload = () => {
            loadCollectedIllusts();
            titleScreen.style.display = 'flex';
            gameScreen.style.display = 'none';
            endingScreen.style.display = 'none';
            galleryScreen.style.display = 'none';
            updateStats();

            titleScreen.style.backgroundImage = `url(${IMAGE_URLS.OPENING_ILLUST})`;
            gameLogo.src = IMAGE_URLS.GAME_LOGO;

            titleScreen.addEventListener('click', startGame);
            showGalleryButton.addEventListener('click', showGalleryScreen);
        };

    </script>
</body>
</html>
